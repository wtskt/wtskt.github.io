<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>WTBlog🥝 | WTBlog🥝</title><meta name="keywords" content="Java,MySQL,算法,代码,博客,Butterfly,Hexo,Fomalhaut🥝,Fomalhaut"><meta name="author" content="Wang Tong🥝"><meta name="copyright" content="Wang Tong🥝"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="导航： 【Java笔记+踩坑汇总】Java基础+JavaWeb+SSM+SpringBoot+SpringCloud+瑞吉外卖&#x2F;谷粒商城&#x2F;学成在线+设计模式+面试题汇总+性能调优&#x2F;架构设计+源码解析 黑马旅游源码： GitHub： GitHub - vincewm&#x2F;hotel: 黑马旅游项目 Gitee： hotel: 黑马旅游项目  目录 1.数据聚合 1.1.聚合的种类 1.2.DSL实现聚">
<meta property="og:type" content="article">
<meta property="og:title" content="WTBlog🥝">
<meta property="og:url" content="https://www.fomal.cc/posts/0.html">
<meta property="og:site_name" content="WTBlog🥝">
<meta property="og:description" content="导航： 【Java笔记+踩坑汇总】Java基础+JavaWeb+SSM+SpringBoot+SpringCloud+瑞吉外卖&#x2F;谷粒商城&#x2F;学成在线+设计模式+面试题汇总+性能调优&#x2F;架构设计+源码解析 黑马旅游源码： GitHub： GitHub - vincewm&#x2F;hotel: 黑马旅游项目 Gitee： hotel: 黑马旅游项目  目录 1.数据聚合 1.1.聚合的种类 1.2.DSL实现聚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://source.fomal.cc/img/default_cover_14.webp">
<meta property="article:published_time" content="2025-03-10T11:39:07.851Z">
<meta property="article:modified_time" content="2025-03-10T11:39:38.982Z">
<meta property="article:author" content="Wang Tong🥝">
<meta property="article:tag" content="Java,MySQL,算法,代码,博客,Butterfly,Hexo,Fomalhaut🥝,Fomalhaut">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://source.fomal.cc/img/default_cover_14.webp"><link rel="shortcut icon" href="/"><link rel="canonical" href="https://www.fomal.cc/posts/0"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'WTBlog🥝',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-03-10 19:39:38'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="WTBlog🥝" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://tuchuang.voooe.cn/images/2023/01/02/avatar.webp" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">4</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> 首页</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> 休闲</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> 八音盒</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> 影院</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> 游戏</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> 八宝箱</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> 画廊</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> 动画</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> 网址导航</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> 社交</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> 网站</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> 网站统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> 文章统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> 旧时光</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> 个人</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/bb/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-qunliaotian">                   </use></svg><span class="menu_word" style="font-size:17px"> 唠叨</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/love/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-love-sign">                   </use></svg><span class="menu_word" style="font-size:17px"> 恋爱小屋</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> 关于</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">WTBlog🥝</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> 首页</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> 休闲</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> 八音盒</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> 影院</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> 游戏</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> 八宝箱</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> 画廊</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> 动画</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> 网址导航</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> 社交</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> 网站</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> 网站统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> 文章统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> 旧时光</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> 个人</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/bb/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-qunliaotian">                   </use></svg><span class="menu_word" style="font-size:17px"> 唠叨</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/love/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-love-sign">                   </use></svg><span class="menu_word" style="font-size:17px"> 恋爱小屋</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> 关于</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="检索站内任何你想要的信息"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg><span> 搜索</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="美化设置-自定义你的风格" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="浅色和深色模式转换" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">无题</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">发表于 </span><time class="post-meta-date-created" datetime="2025-03-10T11:39:07.851Z" title="发表于 2025-03-10 19:39:07">2025-03-10</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-03-10T11:39:38.982Z" title="更新于 2025-03-10 19:39:38">2025-03-10</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">字数总计:</span><span class="word-count">1.3w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">阅读时长:</span><span>53分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p><strong>导航：</strong></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40991313/article/details/126646289?csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22article%22%2C%22rId%22%3A%22126646289%22%2C%22source%22%3A%22qq_40991313%22%7D" title="【Java笔记+踩坑汇总】Java基础+JavaWeb+SSM+SpringBoot+SpringCloud+瑞吉外卖/谷粒商城/学成在线+设计模式+面试题汇总+性能调优/架构设计+源码解析">【Java笔记+踩坑汇总】Java基础+JavaWeb+SSM+SpringBoot+SpringCloud+瑞吉外卖/谷粒商城/学成在线+设计模式+面试题汇总+性能调优/架构设计+源码解析</a></p>
<p><strong>黑马旅游源码：</strong></p>
<p>GitHub：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/vincewm/hotel" title="GitHub - vincewm/hotel: 黑马旅游项目">GitHub - vincewm/hotel: 黑马旅游项目</a></p>
<p>Gitee：</p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/vincewm/hotel" title="hotel: 黑马旅游项目">hotel: 黑马旅游项目</a></p>
</blockquote>
<p><strong>目录</strong></p>
<p>1.数据聚合</p>
<p>1.1.聚合的种类</p>
<p>1.2.DSL实现聚合</p>
<p>1.2.1.Bucket聚合语法</p>
<p>1.2.2.聚合结果排序</p>
<p>1.2.3.通过query标签限定聚合范围</p>
<p>1.2.4.度量聚合语法，stats</p>
<p>1.2.5.小结，聚合三要素</p>
<p>1.3.RestAPI实现聚合</p>
<p>1.3.1.API语法</p>
<p>1.3.2.黑马旅游业务需求，标签随着搜索结果变化</p>
<p>1.3.3.业务实现</p>
<p>2.自动补全</p>
<p>2.1.pinyin拼音分词器的介绍和安装</p>
<p>2.2.自定义分词器，ik+拼音过滤</p>
<p>2.2.1 实现方法</p>
<p>2.2.2 索引分词器和搜索分词器问题</p>
<p>2.3.自动补全查询，conmpetion suggester</p>
<p>2.4.实现酒店搜索框自动补全</p>
<p>2.4.1.创建新索引库，使用自定义分词器</p>
<p>2.4.2.HotelDoc实体类添加suggestion字段</p>
<p>2.4.3.重新导入MySQL数据到es索引库</p>
<p>2.4.4 测试补全，suggest搜索&quot;rj&quot;结果“如家”的文档</p>
<p>2.4.5.自动补全查询的JavaAPI，SuggestBuilder()</p>
<p>2.4.6.实现旅游项目搜索框自动补全</p>
<p>3.mysql与es数据同步</p>
<p>3.1.思路分析</p>
<p>3.1.1.方案一：同步调用</p>
<p>3.1.2.方案二：异步通知</p>
<p>3.1.3.方案三：canal监听mysql的binlog</p>
<p>3.1.4.三种方案优缺点总结</p>
<p>3.2.MQ实现数据同步</p>
<p>3.2.1.思路</p>
<p>3.2.2.导入hotel-admin后台管理端、修改pom和yml</p>
<p>3.2.3.声明交换机、队列</p>
<p>3.2.4.后台端发送MQ消息</p>
<p>3.2.5.用户端接收MQ消息</p>
<p>3.2.6 测试</p>
<p>3.2.7.vue插件实现快速拷贝数据到表单</p>
<p>4.集群</p>
<p>4.0.概述</p>
<p>4.1.搭建ES集群</p>
<p>4.1.0.Docker Compose介绍</p>
<p>4.1.1.创建es集群</p>
<p>4.1.2.集群状态监控，安装cerebro</p>
<p>4.1.3.创建索引库</p>
<p>4.1.4.查看分片效果</p>
<p>4.2.集群脑裂问题</p>
<p>4.2.1.集群职责划分，四种节点类型</p>
<p>4.2.2.脑裂问题</p>
<p>4.2.3.小结，四种节点类型</p>
<p>4.3.集群分布式存储</p>
<p>4.3.1.文档存储到分片测试</p>
<p>4.3.2.分片存储原理</p>
<p>4.4.集群分布式查询，协调节点的分散和聚集</p>
<p>4.5.集群故障转移</p>
<hr>
<h2 id="1-数据聚合">1.数据聚合</h2>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html" title="聚合（">聚合（</a><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html" title="aggregations">aggregations</a><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html" title="）">）</a>可以让我们极其方便的实现对数据的统计、分析、运算。例如：</p>
<ul>
<li>什么品牌的手机最受欢迎？</li>
<li>这些手机的平均价格、最高价格、最低价格？</li>
<li>这些手机每月的销售情况如何？</li>
</ul>
<p>实现这些统计功能的比数据库的sql要方便的多，而且查询速度非常快，可以实现近实时搜索效果。</p>
<h3 id="1-1-聚合的种类">1.1.聚合的种类</h3>
<p>聚合常见的有三类：</p>
<ul>
<li>
<p><strong>桶（Bucket）聚合：</strong> 用来对文档做分组</p>
<ul>
<li>TermAggregation：按照文档字段值分组，例如按照品牌值分组、按照国家分组</li>
<li>Date Histogram：按照日期阶梯分组，例如一周为一组，或者一月为一组</li>
</ul>
</li>
<li>
<p><strong>度量（Metric）聚合</strong> ：用以计算一些值，比如：最大值、最小值、平均值等</p>
<ul>
<li>Avg：求平均值</li>
<li>Max：求最大值</li>
<li>Min：求最小值</li>
<li>Stats：同时求max、min、avg、sum等</li>
</ul>
</li>
<li>
<p><strong>管道（pipeline）聚合：</strong> 其它聚合的结果为基础做聚合</p>
</li>
</ul>
<blockquote>
<p><strong>注意：参加聚合的字段必须是不能分词</strong> ，例如是keyword、日期、数值、布尔类型</p>
</blockquote>
<h3 id="1-2-DSL实现聚合">1.2.DSL实现聚合</h3>
<p>现在，我们要统计所有数据中的酒店品牌有几种，其实就是按照品牌对数据分组。此时可以根据酒店品牌的名称做聚合，也就是Bucket聚合。</p>
<h4 id="1-2-1-Bucket聚合语法">1.2.1.Bucket聚合语法</h4>
<p>语法如下：</p>
<pre><code>GET /hotel/_search
&#123;
  &quot;size&quot;: 0,  // 设置size为0，结果中不包含文档，只包含聚合结果。如果设为20，就是既展示20个brand查询的&quot;hits&quot;，又展示聚合&quot;aggregations&quot;
  &quot;aggs&quot;: &#123; // 定义聚合
    &quot;聚合名&quot;: &#123; //给聚合起个名字，例如brandAgg。查询结果里聚合名会嵌套在&quot;aggregations&quot;里
      &quot;terms&quot;: &#123; // 聚合的类型，按照品牌值聚合，所以选择term
        &quot;field&quot;: &quot;字段名&quot;, // 参与聚合的字段,例如brand
        &quot;size&quot;: 20 // 希望获取的聚合结果数量
        &quot;order&quot;: &#123;
          &quot;_count&quot;: &quot;asc&quot;        //按升序排序，默认是降序
        &#125;
      &#125;
    &#125;
  &#125;
&#125;
</code></pre>
<h4 id="1-2-2-聚合结果排序">1.2.2.聚合结果排序</h4>
<p><strong>默认情况下</strong> ，Bucket聚合会 <strong>统计Bucket内的文档数量</strong> ，记为_count，并且 <strong>按照_count降序</strong> 排序。</p>
<p>我们可以指定order属性，自定义聚合的排序方式：</p>
<pre><code>GET /hotel/_search
&#123;
  &quot;size&quot;: 0, 
  &quot;aggs&quot;: &#123;
    &quot;brandAgg&quot;: &#123;
      &quot;terms&quot;: &#123;
        &quot;field&quot;: &quot;brand&quot;,
        &quot;order&quot;: &#123;
          &quot;_count&quot;: &quot;asc&quot; // 按照_count升序排列
        &#125;,
        &quot;size&quot;: 20        
      &#125;
    &#125;
  &#125;
&#125;
</code></pre>
<p>结果如图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/045507ac495058cc953235172ac15caf.png" alt="image-20210723171948228"></p>
<h4 id="1-2-3-通过query标签限定聚合范围">1.2.3.通过query标签限定聚合范围</h4>
<p>“query” 标签和“aggs”标签是并列的，“query” 标签不为空就是限定了聚合范围。</p>
<p>默认情况下，Bucket聚合是对索引库的所有文档做聚合，但真实场景下，用户会输入搜索条件，因此聚合必须是对搜索结果聚合。那么聚合必须添加限定条件。</p>
<p>我们可以限定要聚合的文档范围，只要添加query条件即可。</p>
<p><strong>需求：</strong> 只对200元以下的文档聚合</p>
<pre><code>GET /hotel/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;range&quot;: &#123;
      &quot;price&quot;: &#123;
        &quot;lte&quot;: 200 // 只对200元以下的文档聚合
      &#125;
    &#125;
  &#125;, 
  &quot;size&quot;: 0, 
  &quot;aggs&quot;: &#123;
    &quot;brandAgg&quot;: &#123;
      &quot;terms&quot;: &#123;
        &quot;field&quot;: &quot;brand&quot;,
        &quot;size&quot;: 20
      &#125;
    &#125;
  &#125;
&#125;
</code></pre>
<p>这次，聚合得到的品牌明显变少了：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/340e991fde6d15a58429560f0412209e.png" alt="image-20210723172404836"></p>
<h4 id="1-2-4-度量聚合语法，stats">1.2.4.度量聚合语法，stats</h4>
<p>上节课，我们对酒店按照品牌分组，形成了一个个桶。</p>
<p><strong>需求：</strong> 现在我们需要 <strong>对桶内的酒店做运算</strong> ，获取每个品牌的用户评分的min、max、avg等值。</p>
<p>这就要用到Metric聚合了，例如stat聚合：就可以获取min、max、avg等结果。</p>
<p>语法如下：</p>
<pre><code>GET /hotel/_search
&#123;
  &quot;size&quot;: 0, 
  &quot;aggs&quot;: &#123;
    &quot;brandAgg&quot;: &#123; 
      &quot;terms&quot;: &#123; 
        &quot;field&quot;: &quot;字段名&quot;, 
        &quot;size&quot;: 20
      &#125;,
      &quot;aggs&quot;: &#123; // 是brands聚合的子聚合，也就是分组后对每组分别计算
        &quot;聚合名如score_stats&quot;: &#123; // 聚合名称
          &quot;stats&quot;: &#123; // 聚合类型，这里stats可以计算min、max、avg等。stats是statistics统计缩写
            &quot;field&quot;: &quot;score&quot; // 聚合字段，这里是score
          &#125;
        &#125;
      &#125;
    &#125;
  &#125;
&#125;
</code></pre>
<p>这次的score_stats聚合是在brandAgg的聚合内部嵌套的子聚合。因为我们需要在每个桶分别计算。</p>
<p>我们还可以给聚合结果做个排序，例如按照每个桶的酒店平均分做排序：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/67670e14a5abe5ee6a15071992bc7287.png" alt="image-20210723172917636"></p>
<h4 id="1-2-5-小结，聚合三要素">1.2.5.小结，聚合三要素</h4>
<p><strong>aggs代表聚合</strong> ，与query同级， <strong>此时query的作用是？</strong></p>
<ul>
<li><strong>限定聚合的的文档范围</strong></li>
</ul>
<p><strong>聚合必须的三要素：</strong></p>
<ul>
<li>聚合 <strong>名称</strong></li>
<li>聚合 <strong>类型</strong></li>
<li>聚合 <strong>字段</strong></li>
</ul>
<p><strong>聚合可配置属性有：</strong></p>
<ul>
<li>size：指定聚合结果数量</li>
<li>order：指定聚合结果排序方式</li>
<li>field：指定聚合字段</li>
</ul>
<h3 id="1-3-RestAPI实现聚合">1.3.RestAPI实现聚合</h3>
<h4 id="1-3-1-API语法">1.3.1.API语法</h4>
<p><strong>聚合条件与query条件同级别</strong> ，因此需要使用 <strong>request.source()</strong> 来指定聚合条件。</p>
<p><strong>聚合条件的语法：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/cc3c1fb77cec69792e9f56a43618ebca.png" alt="image-20210723173057733"></p>
<blockquote>
<p>注意：request.source().aggregation()， <strong>聚合不是负数</strong> ，因为虽然DSL是&quot;aggs&quot;，但它不是数组，所以不是request.source().aggregations()</p>
</blockquote>
<p><strong>聚合结果：</strong></p>
<p>聚合的结果也与查询结果不同，API也比较特殊。不过同样是JSON逐层解析：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/09d867346a4b6e97ec9b8cd190f27370.png" alt="image-20210723173215728"></p>
<blockquote>
<p><strong>注意：</strong> response.getAggregations().get(“brandAgg”)的返回结果要是Terms，注意包别导错了，提示的第一个不是es的包。</p>
<pre><code>    @Test
    public void aggregation()throws IOException&#123;
        SearchRequest request = new SearchRequest(&quot;hotel&quot;);
        request.source().size(0).aggregation(AggregationBuilders.terms(&quot;brandAgg&quot;).field(&quot;brand&quot;).size(20));
        SearchResponse response = client.search(request, RequestOptions.DEFAULT);
        Terms brandTerms =response.getAggregations().get(&quot;brandAgg&quot;);
        List&lt;? extends Terms.Bucket&gt; buckets = brandTerms.getBuckets();
        for(Terms.Bucket bucket:buckets)&#123;
            System.out.println(bucket.getKeyAsString()+&quot;:&quot;+bucket.getDocCount());
        &#125;
    &#125;
</code></pre>
</blockquote>
<h4 id="1-3-2-黑马旅游业务需求，标签随着搜索结果变化">1.3.2.黑马旅游业务需求，标签随着搜索结果变化</h4>
<p>需求：搜索页面的品牌、城市等信息不应该是在页面写死，而是通过聚合索引库中的酒店数据得来的：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/23561e3f118c97e32d3ca8f95d65cc4b.png" alt="image-20210723192605566"></p>
<p><strong>分析：</strong></p>
<p>目前，页面的城市列表、星级列表、品牌列表都是写死的，并不会 <strong>随着搜索结果的变化而变化</strong> 。但是用户搜索条件改变时，搜索结果会跟着变化。</p>
<p>例如：用户搜索“东方明珠”，那搜索的酒店肯定是在上海东方明珠附近，因此，城市只能是上海，此时城市列表中就不应该显示北京、深圳、杭州这些信息了。</p>
<p>也就是说，搜索结果中包含哪些城市，页面就应该列出哪些城市；搜索结果中包含哪些品牌，页面就应该列出哪些品牌。</p>
<p>如何得知搜索结果中包含哪些品牌？如何得知搜索结果中包含哪些城市？</p>
<p>使用聚合功能，利用Bucket聚合，对搜索结果中的文档基于品牌分组、基于城市分组，就能得知包含哪些品牌、哪些城市了。</p>
<p>因为是对搜索结果聚合，因此聚合是 <strong>限定范围的聚合</strong> ，也就是说聚合的限定条件跟搜索文档的条件一致。</p>
<p>查看浏览器可以发现，前端其实已经发出了这样的一个请求：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/ec59aeb80be4ec00296fa013d20de728.png" alt="image-20210723193730799"></p>
<p>请求 <strong>参数与搜索文档的参数完全一致</strong> 。</p>
<p>返回值类型就是页面要展示的最终结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/a4e2be53159a29c46a44a6216cc0269c.png" alt="image-20210723203915982"></p>
<p>结果是一个Map结构：</p>
<ul>
<li>key是字符串，城市、星级、品牌、价格</li>
<li>value是集合，例如多个城市的名称</li>
</ul>
<h4 id="1-3-3-业务实现">1.3.3.业务实现</h4>
<p>在<code>cn.itcast.hotel.web</code>包的<code>HotelController</code>中添加一个方法，遵循下面的要求：</p>
<ul>
<li>请求方式：<code>POST</code></li>
<li>请求路径：<code>/hotel/filters</code></li>
<li>请求参数：<code>RequestParams</code>，与搜索文档的参数一致</li>
<li>返回值类型：<code>Map&lt;String, List&lt;String&gt;&gt;</code></li>
</ul>
<p>代码：</p>
<pre><code>    @PostMapping(&quot;filters&quot;)
    public Map&lt;String, List&lt;String&gt;&gt; getFilters(@RequestBody RequestParams params)&#123;
        return hotelService.getFilters(params);
    &#125;
</code></pre>
<p>这里调用了IHotelService中的getFilters方法，尚未实现。</p>
<p>在<code>cn.itcast.hotel.service.IHotelService</code>中定义新方法：</p>
<pre><code>Map&lt;String, List&lt;String&gt;&gt; filters(RequestParams params);
</code></pre>
<p>在<code>cn.itcast.hotel.service.impl.HotelServiceImpl</code>中实现该方法：</p>
<pre><code>@Override
public Map&lt;String, List&lt;String&gt;&gt; filters(RequestParams params) &#123;
    try &#123;
        // 1.准备Request
        SearchRequest request = new SearchRequest(&quot;hotel&quot;);
        // 2.准备DSL
        // 2.1.query查询城市、品牌等基本信息
        buildBasicQuery(params, request);
        // 2.2.设置size
        request.source().size(0);
        // 2.3.聚合，根据
        buildAggregation(request);
        // 3.发出请求
        SearchResponse response = client.search(request, RequestOptions.DEFAULT);
        // 4.解析结果
        Map&lt;String, List&lt;String&gt;&gt; result = new HashMap&lt;&gt;();
        Aggregations aggregations = response.getAggregations();
        // 4.1.根据品牌名称，获取品牌结果
        List&lt;String&gt; brandList = getAggByName(aggregations, &quot;brandAgg&quot;);
        result.put(&quot;brand&quot;, brandList);
        // 4.2.根据品牌名称，获取品牌结果
        List&lt;String&gt; cityList = getAggByName(aggregations, &quot;cityAgg&quot;);
        result.put(&quot;city&quot;, cityList);
        // 4.3.根据品牌名称，获取品牌结果
        List&lt;String&gt; starList = getAggByName(aggregations, &quot;starAgg&quot;);
        result.put(&quot;starName&quot;, starList);

        return result;
    &#125; catch (IOException e) &#123;
        throw new RuntimeException(e);
    &#125;
&#125;

//三个聚合，分别聚合品牌、城市、星级
private void buildAggregation(SearchRequest request) &#123;
    request.source().aggregation(AggregationBuilders
                                 .terms(&quot;brandAgg&quot;)
                                 .field(&quot;brand&quot;)
                                 .size(100)
                                );
    request.source().aggregation(AggregationBuilders
                                 .terms(&quot;cityAgg&quot;)
                                 .field(&quot;city&quot;)
                                 .size(100)
                                );
    request.source().aggregation(AggregationBuilders
                                 .terms(&quot;starAgg&quot;)
                                 .field(&quot;starName&quot;)
                                 .size(100)
                                );
&#125;

private List&lt;String&gt; getAggByName(Aggregations aggregations, String aggName) &#123;
    // 4.1.根据聚合名称获取聚合结果
    Terms brandTerms = aggregations.get(aggName);
    // 4.2.获取buckets
    List&lt;? extends Terms.Bucket&gt; buckets = brandTerms.getBuckets();
    // 4.3.遍历
    List&lt;String&gt; brandList = new ArrayList&lt;&gt;();
    for (Terms.Bucket bucket : buckets) &#123;
        // 4.4.获取key
        String key = bucket.getKeyAsString();
        brandList.add(key);
    &#125;
    return brandList;
&#125;
</code></pre>
<p>测试：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/56eec2048f5038e0ef201aa5136641e7.png" alt=""></p>
<h2 id="2-自动补全">2.自动补全</h2>
<p>当用户在搜索框输入字符时，我们应该提示出与该字符有关的搜索项，如图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/06589481cf517964d5623b1688cd4bbc.png" alt="image-20210723204936367"></p>
<p>这种根据用户输入的字母，提示完整词条的功能，就是自动补全了。</p>
<p>因为需要根据拼音字母来推断，因此要用到拼音分词功能。</p>
<h3 id="2-1-pinyin拼音分词器的介绍和安装">2.1.pinyin拼音分词器的介绍和安装</h3>
<p>要实现根据字母做补全，就必须对文档按照拼音分词。在GitHub上恰好有elasticsearch的拼音分词插件。地址：</p>
<pre><code>https://github.com/medcl/elasticsearch-analysis-pinyin
</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/98b8c0c0bac49f3c302b5f97af4fc8f5.png" alt="image-20210723205932746"></p>
<p>课前资料中也提供了拼音分词器的安装包：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/2ded121c3d2992e01c8368eddae1e7ed.png" alt="image-20210723205722303"></p>
<p>安装方式与IK分词器一样，分三步：</p>
<p>​ ①解压</p>
<p>​ ②上传到虚拟机中，elasticsearch的plugin目录</p>
<pre><code>/var/lib/docker/volumes/es-plugins/_data
</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/8a2325af75c981cced6ed1e81d01cd75.png" alt=""></p>
<p>​ ③重启elasticsearch</p>
<pre><code>docker restart es
</code></pre>
<p>​ ④测试</p>
<p>详细安装步骤可以参考IK分词器的安装过程。</p>
<p>测试用法如下：</p>
<pre><code>POST /_analyze
&#123;
  &quot;text&quot;: &quot;如家酒店还不错&quot;,
  &quot;analyzer&quot;: &quot;pinyin&quot;
&#125;
</code></pre>
<p>结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/515dfef704bf5a7816b7dd24784c0a3e.png" alt="image-20210723210126506"></p>
<h3 id="2-2-自定义分词器，ik-拼音过滤">2.2.自定义分词器，ik+拼音过滤</h3>
<p>自定义分词器适合在创建索引库时使用，不能在搜索时候用</p>
<h4 id="2-2-1-实现方法">2.2.1 实现方法</h4>
<p>默认的拼音分词器会将每个汉字单独分为拼音，而我们希望的是每个词条形成一组拼音，需要对拼音分词器做个性化定制，形成自定义分词器。</p>
<p>elasticsearch中分词器（analyzer）的组成包含三部分：</p>
<ul>
<li><strong>character filters：</strong> 在tokenizer之前对特 <strong>殊字符进行处理</strong> 。例如删除字符、替换字符</li>
<li><strong>tokenizer：</strong> 将文本按照一定的 <strong>规则切割成词条（term）</strong> 。例如keyword，就是不分词；还有ik_smart</li>
<li><strong>tokenizer filter：</strong> 将tokenizer输出的词条做 <strong>进一步处理，tokenizer的词条结果依然在，只是处理后新加了一些</strong> 。例如大小写转换、同义词处理、拼音处理等</li>
</ul>
<p><strong>拼音分词器处理文档流程：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/79d3cca99ded3a5ff7cf0d71383ca32d.png" alt="image-20210723210427878"></p>
<p><strong>自定义分词器，把ik分词结果过滤成拼音：</strong></p>
<blockquote>
<p><strong>settings-analysis下定义分词器analyzer和filter</strong></p>
</blockquote>
<pre><code>PUT /test
&#123;
   //设置分词器和过滤器
  &quot;settings&quot;: &#123;
    &quot;analysis&quot;: &#123;
      &quot;analyzer&quot;: &#123; // 自定义分词器
        &quot;my_analyzer&quot;: &#123;  // 分词器名称，这里不需要指定character filters过滤器，因为没有特殊字符需要处理
          &quot;tokenizer&quot;: &quot;ik_max_word&quot;,
          &quot;filter&quot;: &quot;my_py_filter&quot;    //对ik分词结果做进一步处理
        &#125;
      &#125;,
      &quot;filter&quot;: &#123; // 自定义tokenizer filter
        &quot;my_py_filter&quot;: &#123; // 过滤器名称
          &quot;type&quot;: &quot;pinyin&quot;, // 过滤器类型，填写分词器名，这里是pinyin
		  &quot;keep_full_pinyin&quot;: false,//eg: 刘德华&gt; [liu,de,hua], default: true
          &quot;keep_joined_full_pinyin&quot;: true,//eg: 刘德华&gt; [liudehua], default: false
          &quot;keep_original&quot;: true,//保留原始输入，默认false
          &quot;limit_first_letter_length&quot;: 16,//
          &quot;remove_duplicated_term&quot;: true,//
          &quot;none_chinese_pinyin_tokenize&quot;: false// 默认true。eg: liudehuaalibaba13zhuanghan -&gt; liu,de,hua,a,li,ba,ba,13,zhuang,han
        &#125;
      &#125;
    &#125;
  &#125;,

  //创建索引
  &quot;mappings&quot;: &#123;
    &quot;properties&quot;: &#123;
      &quot;name&quot;: &#123;
        &quot;type&quot;: &quot;text&quot;,
        &quot;analyzer&quot;: &quot;my_analyzer&quot;,        //拼音分词器适合在创建索引时使用，不能在搜索时候用
        &quot;search_analyzer&quot;: &quot;ik_smart&quot;     //如果搜索时用拼音分词器，搜索&quot;狮子爱跳舞&quot;，会搜出&quot;虱子&quot;等同音字
      &#125;
    &#125;
  &#125;
&#125;
</code></pre>
<blockquote>
<p><strong>注意：</strong></p>
<p><strong>拼音分词器适合在创建索引时使用，不能在搜索时候用</strong> ，如果搜索时用拼音分词器，搜索&quot;狮子爱跳舞&quot;，会搜出&quot;虱子&quot;等同音字。</p>
</blockquote>
<p><strong>测试：自定义分词器搜索结果既有ik_smart，还有拼音分词的结果</strong></p>
<pre><code>GET /test/_analyze
&#123;
  &quot;analyzer&quot;: &quot;my_analyzer&quot;
  , &quot;text&quot;: &quot;今天天气好&quot;
&#125;
</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/046d3e32098bbb5fc838cd8349e798d0.png" alt="image-20210723211829150"></p>
<h4 id="2-2-2-索引分词器和搜索分词器问题">2.2.2 索引分词器和搜索分词器问题</h4>
<p>在使用 <strong>ik+拼音过滤</strong> 的分词器时，建议创建的字段的 <strong>索引分词器设为自定义分词器，搜索分词器设为ik分词器。防止搜索时搜出拼音谐音的情况。</strong></p>
<p><strong>指定索引、搜索分词器，并创建索引：</strong></p>
<pre><code>PUT /test
&#123;
   //设置分词器和过滤器
  &quot;settings&quot;: &#123;
    &quot;analysis&quot;: &#123;
      &quot;analyzer&quot;: &#123; // 自定义分词器
        &quot;my_analyzer&quot;: &#123;  // 分词器名称，这里不需要指定character filters过滤器，因为没有特殊字符需要处理
          &quot;tokenizer&quot;: &quot;ik_max_word&quot;,
          &quot;filter&quot;: &quot;my_py_filter&quot;    //对ik分词结果做进一步处理
        &#125;
      &#125;,
      &quot;filter&quot;: &#123; // 自定义tokenizer filter
        &quot;my_py_filter&quot;: &#123; // 过滤器名称
          &quot;type&quot;: &quot;pinyin&quot;, // 过滤器类型，填写分词器名，这里是pinyin
		  &quot;keep_full_pinyin&quot;: false,//eg: 刘德华&gt; [liu,de,hua], default: true
          &quot;keep_joined_full_pinyin&quot;: true,//eg: 刘德华&gt; [liudehua], default: false
          &quot;keep_original&quot;: true,//保留原始输入，默认false
          &quot;limit_first_letter_length&quot;: 16,//
          &quot;remove_duplicated_term&quot;: true,//
          &quot;none_chinese_pinyin_tokenize&quot;: false// 默认true。eg: liudehuaalibaba13zhuanghan -&gt; liu,de,hua,a,li,ba,ba,13,zhuang,han
        &#125;
      &#125;
    &#125;
  &#125;,

  //创建索引
  &quot;mappings&quot;: &#123;
    &quot;properties&quot;: &#123;
      &quot;name&quot;: &#123;
        &quot;type&quot;: &quot;text&quot;,
        &quot;analyzer&quot;: &quot;my_analyzer&quot;,        //拼音分词器适合在创建索引时使用，不能在搜索时候用
        &quot;search_analyzer&quot;: &quot;ik_smart&quot;     //如果搜索时用拼音分词器，搜索&quot;狮子爱跳舞&quot;，会搜出&quot;虱子&quot;等同音字
      &#125;
    &#125;
  &#125;
&#125;
</code></pre>
<p>建议索引分词器设为自定义分词器，搜索分词器设为ik分词器。防止搜索时搜出拼音谐音问题。</p>
<blockquote>
<p><strong>问题模拟，索引、搜索都用自定义分词器：</strong></p>
<pre><code>DELETE /test

PUT /test
&#123;
  &quot;settings&quot;: &#123;
    &quot;analysis&quot;: &#123;
      &quot;analyzer&quot;: &#123;
        &quot;my_analyzer&quot;:&#123;
          &quot;tokenizer&quot;:&quot;ik_smart&quot;,
          &quot;filter&quot;:&quot;py_filter&quot;
        &#125;
      &#125;,
      &quot;filter&quot;: &#123;
        &quot;py_filter&quot;:&#123;
          &quot;type&quot;:&quot;pinyin&quot;,
          &quot;keep_full_pinyin&quot;: false,
          &quot;keep_joined_full_pinyin&quot;: true,
          &quot;keep_original&quot;: true,
          &quot;limit_first_letter_length&quot;: 16,
          &quot;remove_duplicated_term&quot;: true,
          &quot;none_chinese_pinyin_tokenize&quot;: false
        &#125;
      &#125;
    &#125;
  &#125;,
  &quot;mappings&quot;: &#123;
    &quot;properties&quot;: &#123;
      &quot;name&quot;:&#123;
        &quot;type&quot;: &quot;text&quot;,
        &quot;analyzer&quot;: &quot;my_analyzer&quot;    //统一ik+拼音过滤
      &#125;
    &#125;
  &#125;
&#125;
POST /test/_doc/1
&#123;
  &quot;name&quot;:&quot;狮子&quot;
&#125;

POST /test/_doc/2
&#123;
  &quot;name&quot;:&quot;师资&quot;
&#125;

GET /test/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match&quot;: &#123;
      &quot;name&quot;: &quot;狮子爱跳舞&quot;
    &#125;
  &#125;
&#125;
</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/f27956135fc37053a66dbf5368254b6f.png" alt=""></p>
<p>可以看见，明明搜索的是狮子，却搜出了谐音师资。因为搜索“狮子爱跳舞”时，ik+拼音过滤后的结果里有“shizi”，而师资的分词结果也有“shizi”，所以就搜出了师资。</p>
<p>如果搜索“shizi”，出现结果正常，是狮子和师资。</p>
</blockquote>
<p><strong>解决办法：索引分词器设为自定义分词器，搜索分词器设为ik分词器。防止搜索时搜出拼音谐音问题。</strong></p>
<p>明显不是我们想要的，所以要让它搜索时候只用ik分词，不要拼音过滤就搜不出谐音了，而添加新文档时还要它进行分词拼音，以便于我们可以搜拼音时也能搜出对应字段。</p>
<pre><code>PUT /test
&#123;
   //设置分词器和过滤器
  &quot;settings&quot;: &#123;
     ...自定义分词器
  &#125;,

  //创建索引
  &quot;mappings&quot;: &#123;
    &quot;properties&quot;: &#123;
      &quot;name&quot;: &#123;
        &quot;type&quot;: &quot;text&quot;,
        &quot;analyzer&quot;: &quot;my_analyzer&quot;,        //创建文档时自定义分词器，ik+拼音过滤
        &quot;search_analyzer&quot;: &quot;ik_smart&quot;     //搜索时只用ik分词器
      &#125;
    &#125;
  &#125;
&#125;
</code></pre>
<blockquote>
<p><strong>总结：</strong></p>
<p><strong>如何使用拼音分词器？</strong></p>
<ul>
<li>
<p>①下载pinyin分词器</p>
</li>
<li>
<p>②解压并放到elasticsearch的plugin目录</p>
</li>
<li>
<p>③重启即可</p>
</li>
</ul>
</blockquote>
<blockquote>
<p><strong>如何自定义分词器？</strong></p>
<ul>
<li>
<p>①创建索引库时，在settings中配置，可以包含三部分</p>
</li>
<li>
<p>②character filter</p>
</li>
<li>
<p>③tokenizer</p>
</li>
<li>
<p>④filter</p>
</li>
</ul>
</blockquote>
<blockquote>
<p><strong>拼音分词器注意事项？</strong></p>
<ul>
<li><strong>为了避免搜索到同音字，搜索时不要使用拼音分词器</strong></li>
</ul>
</blockquote>
<h3 id="2-3-自动补全查询，conmpetion-suggester">2.3.自动补全查询，conmpetion suggester</h3>
<p><strong>补全效果预览：</strong> 录入 [“天苍苍”, “野茫茫”]、[“天府”, “天下”]、[“世界”, “黄天”]。suggest搜索“天”，可以搜索出前两个文档。suggest搜索“天苍”，只能搜索出第一个文档。</p>
<p>elasticsearch提供了<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/search-suggesters.html" title="Completion Suggester">Completion Suggester</a>查询来实现自动补全功能。这个查询会匹配以用户输入内容开头的词条并返回。为了提高补全查询的效率，对于文档中字段的类型有一些约束：</p>
<ul>
<li>
<p><strong>参与补全查询的字段必须是completion类型，数据是字符串数组。completion译为完成</strong></p>
</li>
<li>
<p><strong>字段的内容</strong> 一般是用来补全的 <strong>多个词条形成的数组</strong> 。</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/c9c76ec9ecfe3743fc638914e74bee3d.png" alt=""></p>
<p><strong>创建索引库：</strong></p>
<pre><code>// 创建索引库
PUT test
&#123;
  &quot;mappings&quot;: &#123;
    &quot;properties&quot;: &#123;
      &quot;title&quot;:&#123;
        &quot;type&quot;: &quot;completion&quot;    
      &#125;
    &#125;
  &#125;
&#125;
</code></pre>
<p><strong>插入数据：</strong></p>
<pre><code>// 示例数据
POST test/_doc
&#123;
  &quot;title&quot;: [&quot;天苍苍&quot;, &quot;野茫茫&quot;]
&#125;
POST test/_doc
&#123;
  &quot;title&quot;: [&quot;天府&quot;, &quot;天下&quot;]
&#125;
POST test/_doc
&#123;
  &quot;title&quot;: [&quot;世界&quot;, &quot;黄天&quot;]
&#125;
</code></pre>
<p><strong>自动补全查询：</strong></p>
<pre><code>// 自动补全查询
GET /test/_search
&#123;
  &quot;suggest&quot;: &#123;
    &quot;titleSuggest&quot;: &#123;    //例如自定义查询名称
      &quot;text&quot;: &quot;天&quot;, // 关键字
      &quot;completion&quot;: &#123;
        &quot;field&quot;: &quot;title&quot;, // 补全查询的字段，例如title
        &quot;skip_duplicates&quot;: true, // 跳过重复的
        &quot;size&quot;: 10 // 获取前10条结果
      &#125;
    &#125;
  &#125;
&#125;
</code></pre>
<p><strong>搜索结果：</strong></p>
<pre><code>&#123;
  &quot;took&quot; : 275,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 0,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : null,
    &quot;hits&quot; : [ ]
  &#125;,
  &quot;suggest&quot; : &#123;
    &quot;my_suggest&quot; : [
      &#123;
        &quot;text&quot; : &quot;天&quot;,
        &quot;offset&quot; : 0,
        &quot;length&quot; : 1,
        &quot;options&quot; : [
          &#123;
            &quot;text&quot; : &quot;天下&quot;,
            &quot;_index&quot; : &quot;test2&quot;,
            &quot;_type&quot; : &quot;_doc&quot;,
            &quot;_id&quot; : &quot;AEutP4MBg4Wtm5vtyLdE&quot;,
            &quot;_score&quot; : 1.0,
            &quot;_source&quot; : &#123;
              &quot;name&quot; : [
                &quot;天府&quot;,
                &quot;天下&quot;
              ]
            &#125;
          &#125;,
          &#123;
            &quot;text&quot; : &quot;天苍苍&quot;,
            &quot;_index&quot; : &quot;test2&quot;,
            &quot;_type&quot; : &quot;_doc&quot;,
            &quot;_id&quot; : &quot;AUutP4MBg4Wtm5vtyLdI&quot;,
            &quot;_score&quot; : 1.0,
            &quot;_source&quot; : &#123;
              &quot;name&quot; : [
                &quot;天苍苍&quot;,
                &quot;野茫茫&quot;
              ]
            &#125;
          &#125;
        ]
      &#125;
    ]
  &#125;
&#125;
</code></pre>
<h3 id="2-4-实现酒店搜索框自动补全">2.4.实现酒店搜索框自动补全</h3>
<p>现在，我们的hotel索引库还没有设置拼音分词器，需要修改索引库中的配置。但是我们知道索引库是无法修改的，只能删除然后重新创建。</p>
<p>另外，我们需要添加一个字段，用来做自动补全，将brand、suggestion、city等都放进去，作为自动补全的提示。</p>
<p>因此，总结一下，我们需要做的事情包括：</p>
<ol>
<li>
<p>修改hotel索引库结构，设置自定义拼音分词器</p>
</li>
<li>
<p>修改索引库的name、all字段，使用自定义分词器</p>
</li>
<li>
<p>索引库添加一个新字段suggestion，类型为completion类型，使用自定义的分词器</p>
</li>
<li>
<p>给HotelDoc类添加suggestion字段，内容包含brand、business</p>
</li>
<li>
<p>重新导入数据到hotel库</p>
</li>
</ol>
<h4 id="2-4-1-创建新索引库，使用自定义分词器">2.4.1.创建新索引库，使用自定义分词器</h4>
<p>①ik+拼音过滤分词器，给ik分词设置自定义过滤器，给分词进一步处理成拼音。索引使用自定义分词器，搜索使用ik分词器。②关键字+拼音过滤分词器，代码补全使用的分词器。</p>
<p>代码如下：</p>
<pre><code>//酒店数据索引库。先删除旧的，再新的
DELETE /hotel
PUT /hotel
&#123;
  &quot;settings&quot;: &#123;
    &quot;analysis&quot;: &#123;
      &quot;analyzer&quot;: &#123;
        &quot;text_anlyzer&quot;: &#123;    //ik+拼音过滤
          &quot;tokenizer&quot;: &quot;ik_max_word&quot;,
          &quot;filter&quot;: &quot;py&quot;
        &#125;,
        &quot;completion_analyzer&quot;: &#123;    //keyword+拼音过滤，相当于又保持关键词，又新加定制版拼音分词
          &quot;tokenizer&quot;: &quot;keyword&quot;,
          &quot;filter&quot;: &quot;py&quot;
        &#125;
      &#125;,
      &quot;filter&quot;: &#123;
        &quot;py&quot;: &#123;
          &quot;type&quot;: &quot;pinyin&quot;,
          &quot;keep_full_pinyin&quot;: false,
          &quot;keep_joined_full_pinyin&quot;: true,
          &quot;keep_original&quot;: true,
          &quot;limit_first_letter_length&quot;: 16,
          &quot;remove_duplicated_term&quot;: true,
          &quot;none_chinese_pinyin_tokenize&quot;: false
        &#125;
      &#125;
    &#125;
  &#125;,
  &quot;mappings&quot;: &#123;
    &quot;properties&quot;: &#123;
      &quot;id&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;
      &#125;,
      &quot;name&quot;:&#123;
        &quot;type&quot;: &quot;text&quot;,
        &quot;analyzer&quot;: &quot;text_anlyzer&quot;,        //新建文档时分词器用ik+拼音过滤
        &quot;search_analyzer&quot;: &quot;ik_smart&quot;,    //搜索分词器用ik
        &quot;copy_to&quot;: &quot;all&quot;
      &#125;,
      &quot;address&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;,
        &quot;index&quot;: false
      &#125;,
      &quot;price&quot;:&#123;
        &quot;type&quot;: &quot;integer&quot;
      &#125;,
      &quot;score&quot;:&#123;
        &quot;type&quot;: &quot;integer&quot;
      &#125;,
      &quot;brand&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;,
        &quot;copy_to&quot;: &quot;all&quot;
      &#125;,
      &quot;city&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;
      &#125;,
      &quot;starName&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;
      &#125;,
      &quot;business&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;,
        &quot;copy_to&quot;: &quot;all&quot;
      &#125;,
      &quot;location&quot;:&#123;
        &quot;type&quot;: &quot;geo_point&quot;
      &#125;,
      &quot;pic&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;,
        &quot;index&quot;: false
      &#125;,
      &quot;all&quot;:&#123;
        &quot;type&quot;: &quot;text&quot;,
        &quot;analyzer&quot;: &quot;text_anlyzer&quot;,
        &quot;search_analyzer&quot;: &quot;ik_smart&quot;
      &#125;,
      &quot;suggestion&quot;:&#123;    //补全字段suggestion
          &quot;type&quot;: &quot;completion&quot;,    //补全字段类型必须completion
          &quot;analyzer&quot;: &quot;completion_analyzer&quot;    //补全分词器，keyword+拼音过滤
      &#125;
    &#125;
  &#125;
&#125;
</code></pre>
<h4 id="2-4-2-HotelDoc实体类添加suggestion字段">2.4.2.HotelDoc实体类添加suggestion字段</h4>
<p>HotelDoc中要添加一个字段，用来做自动补全，内容可以是酒店品牌、城市、商圈等信息。按照自动补全字段的要求，最好是这些字段的数组。</p>
<p>因此我们在HotelDoc中添加一个suggestion字段，类型为<code>List&lt;String&gt;</code>，然后将brand、city、business等信息放到里面。</p>
<p>代码如下：</p>
<pre><code>package cn.itcast.hotel.pojo;

import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;

@Data
@NoArgsConstructor
public class HotelDoc &#123;
    private Long id;
    private String name;
    private String address;
    private Integer price;
    private Integer score;
    private String brand;
    private String city;
    private String starName;
    private String business;	//商圈，例如虹桥机场/国家会展中心
    private String location;
    private String pic;
    private Object distance;
    private Boolean isAD;
    private List&lt;String&gt; suggestion;	//放自动补全的list列表，这里只补全搜索商圈和品牌

    public HotelDoc(Hotel hotel) &#123;
        this.id = hotel.getId();
        this.name = hotel.getName();
        this.address = hotel.getAddress();
        this.price = hotel.getPrice();
        this.score = hotel.getScore();
        this.brand = hotel.getBrand();
        this.city = hotel.getCity();
        this.starName = hotel.getStarName();
        this.business = hotel.getBusiness();
        this.location = hotel.getLatitude() + &quot;, &quot; + hotel.getLongitude();
        this.pic = hotel.getPic();
        // 组装suggestion，把品牌和商圈放进去
        if(this.business.contains(&quot;/&quot;))&#123;
            // business有多个值，例如“例如虹桥机场/国家会展中心”，需要切割
            String[] arr = this.business.split(&quot;/&quot;);
            // 添加元素
            this.suggestion = new ArrayList&lt;&gt;();
            this.suggestion.add(this.brand);
            Collections.addAll(this.suggestion, arr);
        &#125;else &#123;
            this.suggestion = Arrays.asList(this.brand, this.business);
        &#125;
    &#125;
&#125;
</code></pre>
<h4 id="2-4-3-重新导入MySQL数据到es索引库">2.4.3.重新导入MySQL数据到es索引库</h4>
<p>重新执行之前编写的导入数据功能</p>
<pre><code>    @Test
    public void bulk() throws IOException &#123;
        List&lt;Hotel&gt; hotels = hotelService.list();
        for(Hotel hotel:hotels)&#123;
            HotelDoc hotelDoc = new HotelDoc(hotel);
            client.index(new IndexRequest(&quot;hotel&quot;).id(hotel.getId().toString()).source(JSON.toJSONString(hotelDoc),XContentType.JSON),RequestOptions.DEFAULT);
        &#125;

    &#125;
</code></pre>
<p>查询所有 ，可以看到新的酒店数据中包含了suggestion：</p>
<pre><code>GET /hotel/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match_all&quot;: &#123;&#125;
  &#125;
&#125;
</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/8f19078dec5007b92c9b10aa86e43af9.png" alt="image-20210723213546183"></p>
<h4 id="2-4-4-测试补全，suggest搜索-rj-结果“如家”的文档"><strong>2.4.4 测试补全，suggest搜索&quot;rj&quot;结果“如家”的文档</strong></h4>
<p>因为 <strong>suggestion字段</strong> 自定义分词器是 <strong>keyword+拼音过滤</strong> ，所以搜索“如”搜不出“如家”。搜索“如家”可以搜索出brand为“如家”的一条文档（搜索条件有跳过重复）。搜索“rj”，可以搜索出brand为“如家”的文档</p>
<p><strong>测试：</strong></p>
<pre><code>GET /hotel/_search
&#123;
  &quot;suggest&quot;: &#123;
    &quot;my_suggest&quot;: &#123;
      &quot;text&quot;: &quot;rj&quot;,
      &quot;completion&quot;:&#123;
        &quot;field&quot;: &quot;suggestion&quot;, 
        &quot;skip_duplicates&quot;: true, 
        &quot;size&quot;: 10
      &#125;
    &#125;
  &#125;
&#125;
</code></pre>
<p><strong>因为指定跳过重复，所以搜索结果仅一条：</strong></p>
<pre><code>&#123;
  &quot;took&quot; : 6,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : &#123;
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  &#125;,
  &quot;hits&quot; : &#123;
    &quot;total&quot; : &#123;
      &quot;value&quot; : 0,
      &quot;relation&quot; : &quot;eq&quot;
    &#125;,
    &quot;max_score&quot; : null,
    &quot;hits&quot; : [ ]
  &#125;,
  &quot;suggest&quot; : &#123;
    &quot;my_suggest&quot; : [
      &#123;
        &quot;text&quot; : &quot;如家&quot;,
        &quot;offset&quot; : 0,
        &quot;length&quot; : 2,
        &quot;options&quot; : [
          &#123;
            &quot;text&quot; : &quot;如家&quot;,
            &quot;_index&quot; : &quot;hotel&quot;,
            &quot;_type&quot; : &quot;_doc&quot;,
            &quot;_id&quot; : &quot;415600&quot;,
            &quot;_score&quot; : 1.0,
            &quot;_source&quot; : &#123;
              &quot;address&quot; : &quot;三间房乡褡裢坡村青年沟西侧558号&quot;,
              &quot;brand&quot; : &quot;如家&quot;,
              &quot;business&quot; : &quot;传媒大学/管庄地区&quot;,
              &quot;city&quot; : &quot;北京&quot;,
              &quot;id&quot; : 415600,
              &quot;location&quot; : &quot;39.923212, 116.560023&quot;,
              &quot;name&quot; : &quot;如家酒店(北京朝阳北路传媒大学褡裢坡地铁站店)&quot;,
              &quot;pic&quot; : &quot;https://m.tuniucdn.com/fb3/s1/2n9c/3NezpxNZWQMdNXibwbMkQuAZjDyJ_w200_h200_c1_t0.jpg&quot;,
              &quot;price&quot; : 259,
              &quot;score&quot; : 47,
              &quot;starName&quot; : &quot;二钻&quot;,
              &quot;suggestion&quot; : [
                &quot;如家&quot;,
                &quot;传媒大学&quot;,
                &quot;管庄地区&quot;
              ]
            &#125;
          &#125;
        ]
      &#125;
    ]
  &#125;
&#125;
</code></pre>
<h4 id="2-4-5-自动补全查询的JavaAPI，SuggestBuilder">2.4.5.自动补全查询的JavaAPI，SuggestBuilder()</h4>
<p>之前我们学习了自动补全查询的DSL，而没有学习对应的JavaAPI，这里给出一个示例：</p>
<p>suggest和query是平级的。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/a65054ff019501f975ef140def8e3977.png" alt="image-20210723213759922"></p>
<p>而自动补全的结果也比较特殊，解析的代码如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/9c17c392d2b757c8d611a7925518df35.png" alt="image-20210723213917524"></p>
<h4 id="2-4-6-实现旅游项目搜索框自动补全">2.4.6.实现旅游项目搜索框自动补全</h4>
<p>查看前端页面，可以发现当我们在输入框键入时，前端会发起ajax请求：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/62a79c4576fdfdd7c4321157a58a1ead.png" alt="image-20210723214021062"></p>
<p>返回值是补全词条的集合，类型为<code>List&lt;String&gt;</code></p>
<p>1）在<code>cn.itcast.hotel.web</code>包下的<code>HotelController</code>中添加新接口，接收新的请求：</p>
<pre><code>@GetMapping(&quot;suggestion&quot;)
public List&lt;String&gt; getSuggestions(@RequestParam(&quot;key&quot;) String prefix) &#123;
    return hotelService.getSuggestions(prefix);
&#125;
</code></pre>
<p>2）在<code>cn.itcast.hotel.service</code>包下的<code>IhotelService</code>中添加方法：</p>
<pre><code>List&lt;String&gt; getSuggestions(String prefix);
</code></pre>
<p>3）在<code>cn.itcast.hotel.service.impl.HotelService</code>中实现该方法：</p>
<blockquote>
<p>建议截图补全的es代码，贴到屏幕上，层层解析</p>
</blockquote>
<pre><code>@Override
public List&lt;String&gt; getSuggestions(String prefix) &#123;
    try &#123;
        // 1.准备Request
        SearchRequest request = new SearchRequest(&quot;hotel&quot;);
        // 2.准备DSL
        request.source().suggest(new SuggestBuilder().addSuggestion(    //new SuggestBuilder()不是SuggestBuilders
            &quot;suggestions&quot;,    //自定义补全的名字，后面根据它解析response
            SuggestBuilders.completionSuggestion(&quot;suggestion&quot;)    //字段名
            .prefix(prefix)    //需要补全的文本
            .skipDuplicates(true)
            .size(10)
        ));
        // 3.发起请求
        SearchResponse response = client.search(request, RequestOptions.DEFAULT);
        // 4.解析结果
        Suggest suggest = response.getSuggest();
        // 4.1.根据补全查询名称，获取补全结果，注意返回值和ctrl+alt+v生成的内容不一样
        CompletionSuggestion suggestions = suggest.getSuggestion(&quot;suggestions&quot;);
        // 4.2.获取options
        List&lt;CompletionSuggestion.Entry.Option&gt; options = suggestions.getOptions();
        // 4.3.遍历
        List&lt;String&gt; list = new ArrayList&lt;&gt;(options.size());
        for (CompletionSuggestion.Entry.Option option : options) &#123;
            String text = option.getText().toString();
            list.add(text);
        &#125;
        return list;
    &#125; catch (IOException e) &#123;
        throw new RuntimeException(e);
    &#125;
&#125;
</code></pre>
<p><strong>测试成功：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/f042019c0fc6093edfc66c58cf127869.png" alt=""></p>
<h2 id="3-mysql与es数据同步">3.mysql与es数据同步</h2>
<p>elasticsearch中的酒店数据来自于mysql数据库，因此mysql数据发生改变时，elasticsearch也必须跟着改变，这个就是elasticsearch与mysql之间的 <strong>数据同步</strong> 。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/f331d37395546a44d7f8aa9079de8808.png" alt="image-20210723214758392"></p>
<h3 id="3-1-思路分析">3.1.思路分析</h3>
<p>常见的数据同步方案有三种：</p>
<ul>
<li>同步调用</li>
<li>异步通知</li>
<li>监听binlog</li>
</ul>
<h4 id="3-1-1-方案一：-同步调用">3.1.1. <strong>方案一：</strong> 同步调用</h4>
<p><strong>方案一：同步调用</strong></p>
<p>管理端只能访问mysql，用户端只能访问es，两者间隔离，符合微服务规范。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/c23f8d1027d337c2f55dfcda1aac69a9.png" alt="image-20210723214931869"></p>
<p>基本步骤如下：</p>
<ul>
<li>hotel-demo对外提供接口，用来修改elasticsearch中的数据</li>
<li>酒店管理服务在完成数据库操作后，直接调用hotel-demo提供的接口，</li>
</ul>
<p><strong>缺点：耦合度高</strong></p>
<h4 id="3-1-2-方案二：异步通知">3.1.2.方案二：异步通知</h4>
<p>方案二：异步通知</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/d5998cf60e46a42882a32c396221ea59.png" alt="image-20210723215140735"></p>
<p>流程如下：</p>
<ul>
<li>hotel-admin对mysql数据库数据完成增、删、改后，发送MQ消息</li>
<li>hotel-demo监听MQ，接收到消息后完成elasticsearch数据修改</li>
</ul>
<p>优点：性能高，耦合度低</p>
<p>缺点：依赖于mq消息队列可靠性</p>
<h4 id="3-1-3-方案三：canal监听mysql的binlog">3.1.3.方案三：canal监听mysql的binlog</h4>
<p>canal译为管道，运河。</p>
<blockquote>
<p><strong>回顾主从复制，</strong> 主库开启binlog，从库根据主库binlog的增删改信息，进行相同操作。</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/9c78f220c5746bd227b6a71b6707d7ae.png" alt="image-20210723215518541"></p>
<p>流程如下：</p>
<ul>
<li>给mysql开启binlog功能</li>
<li>mysql完成增、删、改操作都会记录在binlog中</li>
<li>hotel-demo基于canal监听binlog变化，实时更新elasticsearch中的内容</li>
</ul>
<p><strong>优点：</strong> 耦合度最低</p>
<p><strong>缺点：</strong> mysql压力增加</p>
<h4 id="3-1-4-三种方案优缺点总结">3.1.4.三种方案优缺点总结</h4>
<p><strong>方式一：同步调用</strong></p>
<ul>
<li>优点：实现简单，粗暴</li>
<li>缺点：业务 <strong>耦合度高</strong></li>
</ul>
<p><strong>方式二：异步通知</strong></p>
<ul>
<li>优点：低耦合，实现难度一般</li>
<li>缺点： <strong>依赖mq的可靠性</strong></li>
</ul>
<p><strong>方式三：监听binlog</strong></p>
<ul>
<li>优点： <strong>完全解除服务间耦合</strong></li>
<li>缺点：开启binlog增加 <strong>数据库负担</strong> 、实现复杂度高</li>
</ul>
<h3 id="3-2-MQ实现数据同步">3.2.MQ实现数据同步</h3>
<h4 id="3-2-1-思路">3.2.1.思路</h4>
<p>利用课前资料提供的hotel-admin项目作为酒店管理的微服务。当酒店数据发生增、删、改时，要求对elasticsearch中数据也要完成相同操作。</p>
<p><strong>使用RabbitMQ的发布/订阅模型topic话题模式，支持不同的消息根据routingKey被不同的队列消费。先声明交换机、队列，增删两个routingKey。只需要增删两个队列，restapi里增改是一致的，id存在则修改，id不存在则新增。</strong></p>
<blockquote>
<p>忘了就回顾：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40991313/article/details/126801025?spm=1001.2014.3001.5501" title="SpringCloud基础4——RabbitMQ和SpringAMQP">SpringCloud基础4——RabbitMQ和SpringAMQP</a></p>
</blockquote>
<p>步骤：</p>
<ul>
<li>
<p>导入课前资料提供的hotel-admin项目，启动并测试酒店数据的CRUD</p>
</li>
<li>
<p>声明exchange、queue、RoutingKey</p>
</li>
<li>
<p>在hotel-admin中的增、删、改业务中完成消息发送</p>
</li>
<li>
<p>在hotel-demo中完成消息监听，并更新elasticsearch中数据</p>
</li>
<li>
<p>启动并测试数据同步功能</p>
</li>
</ul>
<h4 id="3-2-2-导入hotel-admin后台管理端、修改pom和yml">3.2.2.导入hotel-admin后台管理端、修改pom和yml</h4>
<p>导入课前资料提供的hotel-admin项目：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/c689544193b9602b43405a79410c2351.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/a925855b9112e9b19e859f556fa0f625.png" alt=""></p>
<p><strong>修改pom</strong></p>
<pre><code>        &lt;dependency&gt;
            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;3.4.2&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;1.2.11&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
</code></pre>
<p><strong>修改yml：</strong></p>
<pre><code>server:
  port: 8099
spring:
  datasource:
    druid:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/heima?serverTimezone=Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=false&amp;allowPublicKeyRetrieval=true
      username: root
      password: 1234
  main:
    banner-mode: off
  rabbitmq:
    host: 192.168.200.131
    port: 5672
    username: itcast
    password: 123321
    virtual-host: / #虚拟主机
#logging:
#  level:
#    cn.itcast: debug
#  pattern:
#    dateformat: MM-dd HH:mm:ss:SSS

#  type-aliases-package:com.vince.hotel.pojo
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
  global-config:
    banner: false
</code></pre>
<p>运行后，访问 <a target="_blank" rel="noopener" href="http://localhost:8099">http://localhost:8099</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/333c47760f4ebf7a5f03ceca42ef2949.png" alt="image-20210723220354464"></p>
<p><strong>其中包含了酒店的CRUD功能：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/6f1223739ae4e0c564d0e0e7f0ad224c.png" alt="image-20210723220511090"></p>
<h4 id="3-2-3-声明交换机、队列">3.2.3.声明交换机、队列</h4>
<p>MQ结构如图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/c1e06c92f6a3947c38ec6577cf2a11cc.png" alt="image-20210723215850307"></p>
<p><strong>0)开启RabbitMQ</strong></p>
<pre><code>docker ps -a
docker start 容器名
</code></pre>
<p>管理端：</p>
<pre><code>http://ip地址:15672/
</code></pre>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40991313/article/details/126801025?spm=1001.2014.3001.5501" title="SpringCloud基础4——RabbitMQ_springcloud rabbitmq_vincewm的博客-CSDN博客">SpringCloud基础4——RabbitMQ_springcloud rabbitmq_vincewm的博客-CSDN博客</a></p>
</blockquote>
<p><strong>1）引入依赖、yml</strong></p>
<p>在hotel-admin、hotel-demo中引入rabbitmq的依赖：</p>
<pre><code>&lt;!--amqp--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>yml：</p>
<pre><code>server:
  port: 8099
spring:
  datasource:
    druid:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/heima?serverTimezone=Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=false&amp;allowPublicKeyRetrieval=true
      username: root
      password: 1234
  main:
    banner-mode: off
  rabbitmq:
    host: 192.168.200.131
    port: 5672
    username: itcast
    password: 123321
    virtual-host: / #虚拟主机
#logging:
#  level:
#    cn.itcast: debug
#  pattern:
#    dateformat: MM-dd HH:mm:ss:SSS

#  type-aliases-package:com.vince.hotel.pojo
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
  global-config:
    banner: false
</code></pre>
<p><strong>2）常量类，声明队列交换机名称</strong></p>
<p>在hotel-admin和hotel-demo中的<code>cn.itcast.hotel.constatnts</code>包下新建一个类<code>MqConstants</code>：</p>
<pre><code>package cn.itcast.hotel.constants;

    public class MqConstants &#123;
    /**
     * 交换机
     */
    public final static String HOTEL_EXCHANGE = &quot;hotel.topic&quot;;
    /**
     * 监听新增和修改的队列
     */
    public final static String HOTEL_INSERT_QUEUE = &quot;hotel.insert.queue&quot;;
    /**
     * 监听删除的队列
     */
    public final static String HOTEL_DELETE_QUEUE = &quot;hotel.delete.queue&quot;;
    /**
     * 新增或修改的RoutingKey
     */
    public final static String HOTEL_INSERT_KEY = &quot;hotel.insert&quot;;
    /**
     * 删除的RoutingKey
     */
    public final static String HOTEL_DELETE_KEY = &quot;hotel.delete&quot;;
&#125;
</code></pre>
<p><strong>3）声明队列交换机</strong></p>
<blockquote>
<p><strong>topic模式回顾：话题模式，通配符。</strong><code>Topic</code>类型的<code>Exchange</code>与<code>Direct</code>相比，都是可以根据<code>RoutingKey</code>把消息路由到不同的队列。只不过 <strong><code>Topic</code>类型<code>Exchange</code>可以让队列在绑定<code>Routing key</code> 的时候使用通配符！</strong></p>
<p>也可以在接收消息时，使用注解方式@RabbitListener的bindings，适用于消息队列少的情况:</p>
<pre><code>@RabbitListener(bindings = @QueueBinding(
    value = @Queue(name = &quot;topic.queue1&quot;),
    exchange = @Exchange(name = &quot;itcast.topic&quot;, type = ExchangeTypes.TOPIC),
    key = &quot;china.#&quot;
))
public void listenTopicQueue1(String msg)&#123;
    System.out.println(&quot;消费者接收到topic.queue1的消息：【&quot; + msg + &quot;】&quot;);
&#125;
</code></pre>
</blockquote>
<p>在config包下创建MqConfig，声明队列、交换机：</p>
<pre><code>package cn.itcast.hotel.config;

import cn.itcast.hotel.constants.MqConstants;
import org.springframework.amqp.core.Binding;
import org.springframework.amqp.core.BindingBuilder;
import org.springframework.amqp.core.Queue;
import org.springframework.amqp.core.TopicExchange;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class MqConfig &#123;
    @Bean
    public TopicExchange topicExchange()&#123;
        //第二个参数为是否持久化，第三个参数为是否自动删除。两个参数默认值就是持久化、不自动删除
        return new TopicExchange(MqConstants.HOTEL_EXCHANGE, true, false);
    &#125;

    @Bean
    public Queue insertQueue()&#123;
        return new Queue(MqConstants.HOTEL_INSERT_QUEUE, true);
    &#125;

    @Bean
    public Queue deleteQueue()&#123;
        return new Queue(MqConstants.HOTEL_DELETE_QUEUE, true);
    &#125;

    @Bean
    public Binding insertQueueBinding()&#123;
        return BindingBuilder.bind(insertQueue()).to(topicExchange()).with(MqConstants.HOTEL_INSERT_KEY);
    &#125;

    @Bean
    public Binding deleteQueueBinding()&#123;
        return BindingBuilder.bind(deleteQueue()).to(topicExchange()).with(MqConstants.HOTEL_DELETE_KEY);
    &#125;
&#125;
</code></pre>
<blockquote>
<p><strong>为什么只需要增删两个队列，不用“改” 队列？</strong></p>
<p>在RestClient的API中， <strong>全量修改与新增的API完全一致</strong> ，判断依据是ID：</p>
<ul>
<li>如果新增时，ID已经存在，则修改</li>
<li>如果新增时，ID不存在，则新增</li>
</ul>
</blockquote>
<h4 id="3-2-4-后台端发送MQ消息">3.2.4.后台端发送MQ消息</h4>
<p>在hotel-admin中的增、删、改业务中分别发送MQ消息， <strong>消息内容为id，到时候用户端根据id增删改</strong> ：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/d0afe430f232884b74b2c514806a864f.png" alt="image-20210723221843816"></p>
<h4 id="3-2-5-用户端-接收MQ消息">3.2.5. <strong>用户端</strong> 接收MQ消息</h4>
<p>管理端hotel-admin不能直接调用es，想对es实现增删改要通过给用户端hotel-demo发送新增（修改）、删除消息。</p>
<p><strong>hotel-demo</strong> 接收到MQ消息要做的事情包括：</p>
<ul>
<li><strong>新增消息：</strong> 根据传递的hotel的 <strong>id</strong> 查询hotel信息，然后新增一条数据到 <strong>索引库</strong></li>
<li><strong>删除消息：</strong> 根据传递的hotel的 <strong>id删除索引库</strong> 中的一条数据</li>
</ul>
<p><strong>0） 环境准备</strong></p>
<p>pom</p>
<pre><code>        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<p>yml</p>
<pre><code>spring:
  rabbitmq:
    host: 192.168.200.131
    port: 5672
    username: itcast
    password: 123321
    virtual-host: / #虚拟主机
</code></pre>
<p>复制管理端的MqConstants.java和MqConfig到用户端</p>
<p><strong>1）service接口新增新增、删除业务</strong></p>
<p>首先在hotel-demo的<code>cn.itcast.hotel.service</code>包下的<code>IHotelService</code>中 <strong>新增新增、删除业务</strong></p>
<pre><code>//mp的增删方法是saveById和removeById，所以这里并不冲突
void deleteById(Long id);

void insertById(Long id);
</code></pre>
<p><strong>2）service实现类实现业务</strong></p>
<p>给hotel-demo中的<code>cn.itcast.hotel.service.impl</code>包下的HotelService中 <strong>实现业务：</strong></p>
<pre><code>//mp的增删方法是saveById和removeById，所以这里并不冲突
@Override
public void deleteById(Long id) &#123;
    try &#123;
        // 1.准备Request
        DeleteRequest request = new DeleteRequest(&quot;hotel&quot;, id.toString());
        // 2.发送请求
        client.delete(request, RequestOptions.DEFAULT);
    &#125; catch (IOException e) &#123;
        throw new RuntimeException(e);
    &#125;
&#125;

@Override
public void insertById(Long id) &#123;
    try &#123;
        // 0.根据id查询酒店数据
        Hotel hotel = getById(id);
        // 转换为文档类型
        HotelDoc hotelDoc = new HotelDoc(hotel);

        // 1.准备Request对象
        IndexRequest request = new IndexRequest(&quot;hotel&quot;).id(hotel.getId().toString());
        // 2.准备Json文档
        request.source(JSON.toJSONString(hotelDoc), XContentType.JSON);
        // 3.发送请求
        client.index(request, RequestOptions.DEFAULT);
    &#125; catch (IOException e) &#123;
        throw new RuntimeException(e);
    &#125;
&#125;
</code></pre>
<blockquote>
<p>坑点：删除文档的request别忘了设置id，不然会删除所有数据。</p>
</blockquote>
<p><strong>3）编写监听器</strong></p>
<p><strong>在<code>mq</code>包下</strong>新增一个类：</p>
<pre><code>package cn.itcast.hotel.mq;

import cn.itcast.hotel.constants.MqConstants;
import cn.itcast.hotel.service.IHotelService;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
//别忘了@Component，被ioc容器管理，一直监听
@Component
public class HotelListener &#123;

    @Autowired
    private IHotelService hotelService;

    /**
     * 监听酒店新增或修改的业务
     * @param id 酒店id
     */
    @RabbitListener(queues = MqConstants.HOTEL_INSERT_QUEUE)
    public void listenHotelInsertOrUpdate(Long id)&#123;
        hotelService.insertById(id);
    &#125;

    /**
     * 监听酒店删除的业务
     * @param id 酒店id
     */
    @RabbitListener(queues = MqConstants.HOTEL_DELETE_QUEUE)
    public void listenHotelDelete(Long id)&#123;
        hotelService.deleteById(id);
    &#125;
&#125;
</code></pre>
<h4 id="3-2-6-测试">3.2.6 测试</h4>
<p>运行管理端和用户端服务后，打开rabbitmq服务端： <a target="_blank" rel="noopener" href="http://xn--ip-im8ckc:15672">http://ip地址:15672</a></p>
<p>可以看到队列、交换机创建成功：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/ac708c6b4fc9e95d1dce56a2e136713f.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/ca4855d06902eb5f6c19034a8b07aeda.png" alt=""></p>
<p><strong>交换机绑定关系：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/5c3168cd4f4e917a2385c895f7fb6e80.png" alt=""></p>
<p><strong>先用户端搜索一个酒店，然后在管理端修改酒店信息 ：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/305db1459558cea40dc022dea7a7e454.png" alt=""></p>
<p><strong>可以看到队列的消息记录：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/6efbfddd7b7c980a30e758b1dbed30dd.png" alt=""></p>
<p><strong>用户端搜索后的数据也改变了：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/b9e78c04fa69fd2eb2b2de8be421ffa9.png" alt=""></p>
<p>再删除酒店，发现成功。</p>
<h4 id="3-2-7-vue插件实现快速拷贝数据到表单">3.2.7.vue插件实现快速拷贝数据到表单</h4>
<p><strong>安装地址</strong></p>
<p><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/vuejs-devtools/nhdogjmejiglipccpnnnanhbledajbpd?hl=zh">https://chrome.google.com/webstore/detail/vuejs-devtools/nhdogjmejiglipccpnnnanhbledajbpd?hl=zh</a></p>
<p><strong>拷贝数据并保存的办法：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/ef70c8fa4ce05c945fa49eb1fbd911d5.png" alt=""></p>
<p>粘贴即可快速填充表单：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/5c416e57971703394c70aa05340d4bb6.png" alt=""></p>
<h2 id="4-集群">4.集群</h2>
<h3 id="4-0-概述">4.0.概述</h3>
<p>单机的elasticsearch做数据存储，必然面临两个问题：海量数据存储问题、单点故障问题。</p>
<ul>
<li><strong>海量数据存储问题：</strong> 将 <strong>索引库</strong> 从逻辑 <strong>上拆分为N个分片</strong> （shard），存储到多个节点</li>
<li><strong>单点故障问题：将分片数据在不同节点备份</strong> （replica ）</li>
</ul>
<p><strong>ES集群相关概念</strong> :</p>
<p><strong>一个集群里有多个节点，每个节点都是一个es实例， 每个节点保存了自己的分片和一个其他节点备份的分片。</strong></p>
<ul>
<li>
<p><strong>集群（cluster）</strong> ：一组拥有共同的 集群名 的 节点。</p>
</li>
<li>
<p><strong>节点（node) ：</strong> 集群中的一个 Elasticearch 实例</p>
</li>
<li>
<p><strong>分片（shard）：</strong> 索引可以被拆分为不同的部分进行存储，称为分片。在集群环境下， <strong>一个索引的不同分片可以拆分到不同的节点中</strong></p>
</li>
</ul>
<p><strong>解决问题：</strong> 数据量太大，单点存储量有限的问题。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/e3e8914f1418efc3923e087ce2667e11.png" alt="image-20200104124440086"></p>
<blockquote>
<p>此处，我们把数据分成3片：shard0、shard1、shard2</p>
</blockquote>
<ul>
<li>
<p><strong>主分片（Primary shard）：</strong> 相对于副本分片的定义。</p>
</li>
<li>
<p><strong>副本分片（Replica shard）：</strong> 每个主分片可以有一个或者多个副本， <strong>数据和主分片一样</strong> 。</p>
</li>
</ul>
<p>​</p>
<p>数据备份可以保证高可用，但是每个分片备份一份，所需要的节点数量就会翻一倍，成本实在是太高了！</p>
<p>为了在高可用和成本间寻求平衡，我们可以这样做：</p>
<ul>
<li>首先对数据分片，存储到不同节点</li>
<li>然后对 <strong>每个分片进行备份，放到对方节点，完成互相备份</strong></li>
</ul>
<p>这样可以大大减少所需要的服务节点数量，如图，我们以3分片，每个分片备份一份为例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/0f744585940501b4513e67af778f62cf.png" alt="image-20200104124551912"></p>
<p>现在，每个分片都有1个备份，存储在3个节点：</p>
<ul>
<li><strong>节点node0：保存了分片0和1</strong></li>
<li>node1：保存了分片0和2</li>
<li>node2：保存了分片1和2</li>
</ul>
<h3 id="4-1-搭建ES集群">4.1.搭建ES集群</h3>
<h4 id="4-1-0-Docker-Compose介绍">4.1.0.Docker Compose介绍</h4>
<p>Docker Compose是一个用来定义和运行复杂应用的Docker工具，将一个或多个容器组合成一个完整的应用程序。一个使用Docker容器的应用，通常由多个容器组成。使用Docker Compose不再需要使用shell脚本来启动容器。</p>
<p>Compose 通过一个 <strong>配置文件</strong> 来管理多个Docker容器，在配置文件中，所有的容器通过 <strong>services</strong> 来定义，然后使用 <strong>docker-compose脚本</strong> 来启动，停止和重启应用，和应用中的服务以及所有依赖服务的容器，非常适合组合使用多个容器进行开发的场景。</p>
<p><strong>Docker Compose 使用的三个步骤：</strong></p>
<ol>
<li>使用 Dockerfile 定义应用程序的环境</li>
<li>使用 docker-compose.yml 定义构成应用程序的服务，这样它们可以在隔离环境中一起运行</li>
<li>执行 docker-compose up 命令（后面加-d是在后台运行）来启动并运行整个应用程序</li>
</ol>
<h4 id="4-1-1-创建es集群">4.1.1.创建es集群</h4>
<p>创建同一个集群的三个节点，每个节点都是一个es实例：</p>
<p><strong>①首先编写一个docker-compose.yml文件</strong> ，上传到/root，内容如下：</p>
<blockquote>
<p><strong>注意端口占用问题</strong> ：ports:-9200:9200，左边是centos的端口，右边是容器内部端口，只有左边会发生端口占用问题，前面安装过单点es的默认接口是9200，注意一下。</p>
</blockquote>
<pre><code>#创建三个es容器，容器名和节点名都是es01、es02、es03。

version: '2.2'
services:
  es01:
    image: elasticsearch:7.12.1    #镜像名称
    container_name: es01    #容器名称
    environment:
      - node.name=es01
#集群名称。三个容器集群名称一样，es会自动把他们组装成一个集群。
      - cluster.name=es-docker-cluster    
#集群中其他节点的ip地址；docker容器之间通过名字直接相互访问
      - discovery.seed_hosts=es02,es03	
#集群中可以参与选举的主节点
      - cluster.initial_master_nodes=es01,es02,es03
      - &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;    #内存大小，最小和最大内存
    volumes:
      - data01:/usr/share/elasticsearch/data
    ports:
      - 9200:9200    #对外端口9200：对内端口9200
    networks:
      - elastic
  es02:
    image: elasticsearch:7.12.1
    container_name: es02
    environment:
      - node.name=es02
#集群名称。三个容器集群名称一样，es会自动把他们组装成一个集群。
      - cluster.name=es-docker-cluster
      - discovery.seed_hosts=es01,es03
      - cluster.initial_master_nodes=es01,es02,es03
      - &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;
    volumes:
      - data02:/usr/share/elasticsearch/data
    ports:
      - 9201:9200
    networks:
      - elastic
  es03:
    image: elasticsearch:7.12.1
    container_name: es03
    environment:
      - node.name=es03
      - cluster.name=es-docker-cluster
#集群名称。三个容器集群名称一样，es会自动把他们组装成一个集群。
      - discovery.seed_hosts=es01,es02
      - cluster.initial_master_nodes=es01,es02,es03
      - &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;
    volumes:
      - data03:/usr/share/elasticsearch/data
    networks:
      - elastic
    ports:
      - 9202:9200
volumes:
  data01:
    driver: local
  data02:
    driver: local
  data03:
    driver: local

networks:
  elastic:
    driver: bridge
</code></pre>
<p><strong>②修改权限：</strong></p>
<p>es运行需要修改一些linux系统权限，修改<code>/etc/sysctl.conf</code>文件</p>
<pre><code>vi /etc/sysctl.conf
</code></pre>
<p>添加下面的内容，或将注释打开：</p>
<pre><code>vm.max_map_count=262144
</code></pre>
<p>然后执行命令， <strong>让配置生效</strong> ：</p>
<pre><code>sysctl -p
</code></pre>
<p><strong>③通过docker-compose up启动集群：</strong></p>
<pre><code>docker-compose up -d
</code></pre>
<h4 id="4-1-2-集群状态监控，安装cerebro">4.1.2.集群状态监控，安装cerebro</h4>
<p>kibana可以监控es集群，不过新版本需要依赖es的x-pack 功能，配置比较复杂。</p>
<p>这里推荐使用cerebro来监控es集群状态，官方网址：<a target="_blank" rel="noopener" href="https://github.com/lmenezes/cerebro">https://github.com/lmenezes/cerebro</a></p>
<p>课前资料已经提供了安装包：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/596c94f7f44515c7ae1220f444b51784.png" alt="image-20210602220751081"></p>
<p><strong>windows解压即可</strong> 使用，非常方便。</p>
<p>解压好的目录如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/15e310b7a92b136bdb101cb26407f8a2.png" alt="image-20210602220824668"></p>
<p>进入对应的bin目录：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/d9b49750ab83b43060a78100f684770f.png" alt="image-20210602220846137"></p>
<p>双击其中的cerebro.bat文件即可启动服务。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/4d3f2df39357b23d5278da98f5a23a5d.png" alt="image-20210602220941101"></p>
<p>访问http://localhost:9000 即可进入管理界面：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/3bd5f3cb539c0ff27cfbb814285949ef.png" alt="image-20210602221115763"></p>
<p>输入你的elasticsearch的任意节点的地址和端口，点击connect即可：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/35e30f4b039d8777d52caa0b2c64c094.png" alt="image-20210109181106866"></p>
<p>绿色的条，代表集群处于绿色（健康状态）。</p>
<h4 id="4-1-3-创建索引库">4.1.3.创建索引库</h4>
<p><strong>1）方法一：利用kibana的DevTools创建索引库</strong></p>
<p>在DevTools中输入指令：</p>
<pre><code>PUT /itcast
&#123;
  &quot;settings&quot;: &#123;
    &quot;number_of_shards&quot;: 3, // 分片数量，shard译为碎片
    &quot;number_of_replicas&quot;: 1 // 副本数量，replica译为副本，复制品。
  &#125;,
  &quot;mappings&quot;: &#123;
    &quot;properties&quot;: &#123;
      // mapping映射定义 ...
    &#125;
  &#125;
&#125;
</code></pre>
<p><strong>2）方法二：利用cerebro创建索引库</strong></p>
<p>利用cerebro还可以创建索引库：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/130cb3bc96be83f8908cd7a6d7c667ef.png" alt="image-20210602221409524"></p>
<p>填写索引库信息：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/d1bc735f9f44b68bf3b338042670ba4a.png" alt="image-20210602221520629"></p>
<p>点击右下角的create按钮：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/3576486d9004b5d663c4f043e7233de7.png" alt="image-20210602221542745"></p>
<h4 id="4-1-4-查看分片效果">4.1.4.查看分片效果</h4>
<p>回到首页，即可查看索引库分片效果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/75663fb18df1ef24ea0e484f61a823cf.png" alt="image-20210602221914483"></p>
<h3 id="4-2-集群脑裂问题">4.2.集群脑裂问题</h3>
<h4 id="4-2-1-集群职责划分，四种节点类型">4.2.1.集群职责划分，四种节点类型</h4>
<p><strong>集群职责划分：</strong></p>
<ul>
<li>
<p><strong>候选主节点（master eligible）：</strong> 管理集群状态，处理索引库增删请求。</p>
</li>
<li>
<p><strong>数据节点（data）：</strong> 对记录的增删改查。</p>
</li>
<li>
<p><strong>接待节点（ingest）：</strong> 数据存储前的预处理。</p>
</li>
</ul>
<p><strong>协作节点（coordinating）：</strong> 将请求路由其他节点，合并处理结果并返回。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/1a3c241d05840259906fe1e662f077f0.png" alt="image-20210723223008967"></p>
<blockquote>
<p>主节点的类型也是master eligible，它是备选主节点选出来的。</p>
<p><strong>eligible 译为合格的，合适的。</strong></p>
<p><strong>ingest译为接待、吸收。</strong></p>
<p><strong>coordinating译为协调，合作。</strong></p>
</blockquote>
<p><strong>默认情况下</strong> ，集群中的任何一个节点都 <strong>同时具备上述四种角色</strong> 。</p>
<p>但是 <strong>真实的集群</strong> 一定要将 <strong>集群职责分离</strong> ：</p>
<p>职责分离可以让我们根据不同节点的需求分配不同的硬件去部署。而且避免业务之间的互相干扰。</p>
<p><strong>典型的es集群职责划分：LB是负载均衡</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/c3ba5b8b43958c73f8d9bad7f5ef87d7.png" alt="image-20210723223629142"></p>
<h4 id="4-2-2-脑裂问题">4.2.2.脑裂问题</h4>
<p><strong>选举master条件：</strong> 当一个节点发现包括自己在内的多数派的master-eligible节点认为集群没有master时，就可以发起master选举。</p>
<p><strong>选举master过程：</strong></p>
<ol>
<li>
<p>备选主节点首先根据节点id（第一次启动时生成的随机字符串）排序，第一个节点暂定master；</p>
</li>
<li>
<p>如果有(n+1)/2个节点投票它是mater，并且它自己也给自己投票，则它当选master；</p>
</li>
<li>
<p>否则就暂定第二个节点为master，以此类推。</p>
</li>
</ol>
<p><strong>脑裂：</strong> master故障，集群选举出新master后旧master又恢复了，导致集群出现了两个master。</p>
<p><strong>&quot;脑裂&quot;成因：</strong></p>
<ul>
<li>
<p><strong>网络延迟导致误判：</strong> 集群间的网络延迟导致一些节点访问不到master, 认为master 挂掉了从而选举出新的master,并对master上的分片和副本标红，分配新的主分片</p>
</li>
<li>
<p><strong>主节点负载过高导致误判：</strong> 主节点的角色既为master又为data,访问量较大时可能会导致ES停止响应造成大面积延迟，此时其他节点得不到主节点的响应认为主节点挂掉了，会重新选取主节点</p>
</li>
<li>
<p><strong>内存回收导致误判：</strong> data 节点上的ES进程占用的内存较大，引发JVM的大规模内存回收，造成ES进程失去响应，从而长时间没ping通主节点，导致误判主节点下线</p>
</li>
<li>
<p><strong>主节点故障</strong> 。</p>
</li>
</ul>
<p><strong>解决方案：</strong></p>
<ul>
<li>
<p><strong>调大超时时间减少误判：</strong> discovery.zen.ping_timeout节点状态的响应时间，默认为3s，可以适当调大，如果master在该响应时间的范围内没有做出响应应答，判断该节点已经挂掉了。调大参数（如6s，discovery.zen.ping_timeout:6），可适当减少误判</p>
</li>
<li>
<p><strong>选举触发条件：</strong> discovery.zen.minimum_master_nodes:(备选主节点数量/ 2) +1。该参数是用于控制选举条件，只有(n / 2) +1个备选主节点认为主节点故障才开始选举。在es7.0以后，已经成为默认配置，因此一般不会发生脑裂问题</p>
</li>
<li>
<p><strong>master和data分离：</strong> 即master节点与data节点分离，限制角色</p>
<ul>
<li>
<p>主节点配置为：node.master: true，node.data: false</p>
</li>
<li>
<p>从节点配置为：node.master: false，node.data: true</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>脑裂 <strong>是由集群中的节点失联导致的。</strong></p>
<p><strong>脑裂情况演示：</strong></p>
<p>例如一个集群中，主节点与其它节点失联：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/fde04bc2628246aa4b4a58c2ce7cef3e.png" alt="image-20210723223804995"></p>
<p>此时，node2和node3认为node1宕机（但其实只是阻塞了），就会重新选主：</p>
<p>宕机，即down机、死机。</p>
<p>指<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/192?fromModule=lemma_inlink" title="操作系统">操作系统</a>无法从一个严重系统错误中恢复过来，或系统<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%A1%AC%E4%BB%B6/479446?fromModule=lemma_inlink" title="硬件">硬件</a>层面出问题，以致系统长时间无响应，而不得不重新启动计算机的现象。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/1fe75fadbba300181c5ef805fab9b090.png" alt="image-20210723223845754"></p>
<p>当node3当选后，集群继续对外提供服务，node2和node3自成集群，node1自成集群，两个集群数据不同步，出现数据差异。</p>
<p>当网络恢复后，因为集群中有两个master节点，集群状态的不一致，出现脑裂的情况：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/543ddad36df9e7bba38c91a250113055.png" alt="image-20210723224000555"></p>
<p><strong>解决脑裂</strong></p>
<p><strong>解决脑裂的方案</strong> 是，要求选票超过 ( eligible节点数量 + 1 ）/ 2 才能当选为主，因此 <strong>eligible节点数量最好是奇数</strong> 。对应配置项是 <strong>discovery.zen.minimum_master_nodes</strong> ，在es7.0以后，已经成为 <strong>默认配置</strong> ，因此 <strong>一般不会发生脑裂问题</strong></p>
<p>例如：3个节点形成的集群，选票必须超过 （3 + 1） / 2 ，也就是2票。node3得到node2和node3的选票，当选为主。node1只有自己1票，没有当选。集群中依然只有1个主节点，没有出现脑裂。</p>
</blockquote>
<h4 id="4-2-3-小结，四种节点类型">4.2.3.小结，四种节点类型</h4>
<p>master eligible节点的作用是什么？</p>
<p>data节点的作用是什么？</p>
<p>coordinator节点的作用是什么？</p>
<h3 id="4-3-集群分布式存储">4.3.集群分布式存储</h3>
<p>当新增文档时，应该保存到不同分片，保证数据均衡，那么 <strong>coordinating node如何确定数据该存储到哪个分片</strong> 呢？</p>
<h4 id="4-3-1-文档存储到分片测试">4.3.1.文档存储到分片测试</h4>
<blockquote>
<p><strong>一个集群里有多个节点，每个节点都是一个es实例， 每个节点保存了自己的分片和一个其他节点备份的分片。</strong></p>
</blockquote>
<p><strong>在9200端口的es插入三条数据：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/d61f286063add87f52c72ec7fa168c79.png" alt="image-20210723225006058"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/f834dd5a25743690b6ba9e330e3d26f5.png" alt="image-20210723225034637"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/6434db5977e1023a784aa5d0bbd34e40.png" alt="image-20210723225112029"></p>
<p>测试可以看到， <strong>三条数据分别在不同分片：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/3a4b8caa2b711a2034790905020eafff.png" alt="image-20210723225227928"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/4c06fbd63ddf24d72ad4acb0d4cbf67c.png" alt="image-20210723225342120"></p>
<h4 id="4-3-2-分片存储原理">4.3.2.分片存储原理</h4>
<p><strong>分布式新增如何确定分片？</strong></p>
<p>elasticsearch会通过 <strong>hash算法来计算文档应该存储到哪个分片，跟文档id和分片数量有关：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/07e46766cf5654071a12d76e2ae59dea.png" alt="image-20210723224354904"></p>
<blockquote>
<p>说明：</p>
<ul>
<li>_routing默认是文档的id</li>
<li>算法与分片数量有关，因此索引库一旦创建， <strong>分片数量不能修改！</strong></li>
</ul>
</blockquote>
<p><strong>新增文档的流程如下：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/f0be01a97750fd79a596b1cff21dd280.png" alt="image-20210723225436084"></p>
<p>解读：</p>
<h3 id="4-4-集群分布式查询，协调节点的分散和聚集">4.4.集群分布式查询，协调节点的分散和聚集</h3>
<p>elasticsearch的查询分成两个阶段：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/cd4634cf75764dc3ea1d52cc98715ec1.png" alt="image-20210723225809848"></p>
<h3 id="4-5-集群故障转移">4.5.集群故障转移</h3>
<p>集群的 <strong>master节点会监控集群中的节点状态</strong> ，如果发现有节点宕机，会立即 <strong>将宕机节点的分片数据迁移到其它节点</strong> ，确保数据安全，这个叫做 <strong>故障转移</strong> 。</p>
<p><strong>故障转移流程演示：</strong></p>
<p><strong>1）例如一个集群结构如图：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/ef30f03e68948523b2427754fe163349.png" alt="image-20210723225945963"></p>
<p>现在，node1是主节点，其它两个节点是从节点。</p>
<p><strong>2）突然，node1发生了故障：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/a121dde6d1f676a1cb1d565feaf41ad6.png" alt="image-20210723230020574"></p>
<p><strong>宕机后的第一件事，需要重新选主，例如选中了node2：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/28f68706acb3e7ad9419426b8d1873b2.png" alt="image-20210723230055974"></p>
<p><strong>node2成为主节点后，会检测集群监控状态，发现：shard-1、shard-0没有副本节点。因此需要将node1上的数据迁移到node2、node3：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/6dd6f800d7b545907fb305f79099f044.png" alt="image-20210723230216642"></p>
<p><strong>实际演示：</strong></p>
<p>现在有三个节点，其中es01是主节点。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/4c8615c41550eed333c4124b90ceaf15.png" alt=""></p>
<p><strong>令es01宕机</strong></p>
<pre><code>docker-compose stop es01
</code></pre>
<p>此时es01节点上的1主分片和0副本分片没了，主节点转到es03，控制es01节点的数据迁移到es02和03。</p>
<p>故障转移后，所有分片都有主分片和副本分片：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/ca16313524692c750fb8e87c9692a7ec.png" alt=""></p>
<p><strong>再恢复es01，发现主节点es03迁移出两个分片到es01：</strong></p>
<pre><code>docker-compose start es01
</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../assets/es/caf76cb00cd9eb0a076275fa1a865116.png" alt=""></p>
<ul>
<li>
<p><strong>master节点：</strong> 对CPU要求高，但是内存要求低</p>
</li>
<li>
<p><strong>data节点：</strong> 对CPU和内存要求都高</p>
</li>
<li>
<p><strong>coordinating节点：</strong> 对网络带宽、CPU要求高</p>
</li>
<li>
<p>参与集群选主</p>
</li>
<li>
<p><strong>主节点可以管理集群状态、管理分片信息、处理创建和删除索引库的请求</strong></p>
</li>
<li>
<p>数据的CRUD</p>
</li>
<li>
<p><strong>路由请求</strong> 到其它节点</p>
</li>
<li>
<p><strong>合并</strong> 查询到的 <strong>结果</strong> ，返回给用户</p>
</li>
<li>
<p>1）新增一个id=1的文档</p>
</li>
<li>
<p>2）对id做hash运算，假如得到的是2，则应该存储到shard-2</p>
</li>
<li>
<p>3）shard-2的主分片在node3节点，将数据路由到node3</p>
</li>
<li>
<p>4）保存文档</p>
</li>
<li>
<p>5）同步给shard-2的副本replica-2，在node2节点</p>
</li>
<li>
<p>6）返回结果给coordinating-node节点</p>
</li>
<li>
<p><strong>scatter phase：分散阶段</strong> ，coordinating node会把 <strong>请求分发到每一个分片</strong> （只有data节点保存分片数据）</p>
</li>
<li>
<p><strong>gather phase：聚集阶段</strong> ，coordinating node汇总data node的搜索结果，并处理为最终结果集返回给用户</p>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h></h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://www.fomal.cc/posts/0.html">https://www.fomal.cc/posts/0.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>Wang Tong🥝</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2025-03-10</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2025-03-10</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">投喂作者</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://tuchuang.voooe.cn/images/2023/01/04/2.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://tuchuang.voooe.cn/images/2023/01/04/2.webp" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://tuchuang.voooe.cn/images/2023/01/04/20f8e49805975b8f8.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://tuchuang.voooe.cn/images/2023/01/04/20f8e49805975b8f8.webp" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/cec52606.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_14.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">rabbitMQ学习笔记</div></div></a></div><div class="next-post pull-right"><a href="/posts/fa44ecc1.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_14.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">elasticsearch学习笔记</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%95%B0%E6%8D%AE%E8%81%9A%E5%90%88"><span class="toc-text">1.数据聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E8%81%9A%E5%90%88%E7%9A%84%E7%A7%8D%E7%B1%BB"><span class="toc-text">1.1.聚合的种类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-DSL%E5%AE%9E%E7%8E%B0%E8%81%9A%E5%90%88"><span class="toc-text">1.2.DSL实现聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-Bucket%E8%81%9A%E5%90%88%E8%AF%AD%E6%B3%95"><span class="toc-text">1.2.1.Bucket聚合语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-%E8%81%9A%E5%90%88%E7%BB%93%E6%9E%9C%E6%8E%92%E5%BA%8F"><span class="toc-text">1.2.2.聚合结果排序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-%E9%80%9A%E8%BF%87query%E6%A0%87%E7%AD%BE%E9%99%90%E5%AE%9A%E8%81%9A%E5%90%88%E8%8C%83%E5%9B%B4"><span class="toc-text">1.2.3.通过query标签限定聚合范围</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-4-%E5%BA%A6%E9%87%8F%E8%81%9A%E5%90%88%E8%AF%AD%E6%B3%95%EF%BC%8Cstats"><span class="toc-text">1.2.4.度量聚合语法，stats</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-5-%E5%B0%8F%E7%BB%93%EF%BC%8C%E8%81%9A%E5%90%88%E4%B8%89%E8%A6%81%E7%B4%A0"><span class="toc-text">1.2.5.小结，聚合三要素</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-RestAPI%E5%AE%9E%E7%8E%B0%E8%81%9A%E5%90%88"><span class="toc-text">1.3.RestAPI实现聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-1-API%E8%AF%AD%E6%B3%95"><span class="toc-text">1.3.1.API语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-%E9%BB%91%E9%A9%AC%E6%97%85%E6%B8%B8%E4%B8%9A%E5%8A%A1%E9%9C%80%E6%B1%82%EF%BC%8C%E6%A0%87%E7%AD%BE%E9%9A%8F%E7%9D%80%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E5%8F%98%E5%8C%96"><span class="toc-text">1.3.2.黑马旅游业务需求，标签随着搜索结果变化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-3-%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="toc-text">1.3.3.业务实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><span class="toc-text">2.自动补全</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-pinyin%E6%8B%BC%E9%9F%B3%E5%88%86%E8%AF%8D%E5%99%A8%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E5%AE%89%E8%A3%85"><span class="toc-text">2.1.pinyin拼音分词器的介绍和安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E8%AF%8D%E5%99%A8%EF%BC%8Cik-%E6%8B%BC%E9%9F%B3%E8%BF%87%E6%BB%A4"><span class="toc-text">2.2.自定义分词器，ik+拼音过滤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95"><span class="toc-text">2.2.1 实现方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E7%B4%A2%E5%BC%95%E5%88%86%E8%AF%8D%E5%99%A8%E5%92%8C%E6%90%9C%E7%B4%A2%E5%88%86%E8%AF%8D%E5%99%A8%E9%97%AE%E9%A2%98"><span class="toc-text">2.2.2 索引分词器和搜索分词器问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8%E6%9F%A5%E8%AF%A2%EF%BC%8Cconmpetion-suggester"><span class="toc-text">2.3.自动补全查询，conmpetion suggester</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%AE%9E%E7%8E%B0%E9%85%92%E5%BA%97%E6%90%9C%E7%B4%A2%E6%A1%86%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><span class="toc-text">2.4.实现酒店搜索框自动补全</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-%E5%88%9B%E5%BB%BA%E6%96%B0%E7%B4%A2%E5%BC%95%E5%BA%93%EF%BC%8C%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-text">2.4.1.创建新索引库，使用自定义分词器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-HotelDoc%E5%AE%9E%E4%BD%93%E7%B1%BB%E6%B7%BB%E5%8A%A0suggestion%E5%AD%97%E6%AE%B5"><span class="toc-text">2.4.2.HotelDoc实体类添加suggestion字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-3-%E9%87%8D%E6%96%B0%E5%AF%BC%E5%85%A5MySQL%E6%95%B0%E6%8D%AE%E5%88%B0es%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-text">2.4.3.重新导入MySQL数据到es索引库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-4-%E6%B5%8B%E8%AF%95%E8%A1%A5%E5%85%A8%EF%BC%8Csuggest%E6%90%9C%E7%B4%A2-rj-%E7%BB%93%E6%9E%9C%E2%80%9C%E5%A6%82%E5%AE%B6%E2%80%9D%E7%9A%84%E6%96%87%E6%A1%A3"><span class="toc-text">2.4.4 测试补全，suggest搜索&quot;rj&quot;结果“如家”的文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-5-%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8%E6%9F%A5%E8%AF%A2%E7%9A%84JavaAPI%EF%BC%8CSuggestBuilder"><span class="toc-text">2.4.5.自动补全查询的JavaAPI，SuggestBuilder()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-6-%E5%AE%9E%E7%8E%B0%E6%97%85%E6%B8%B8%E9%A1%B9%E7%9B%AE%E6%90%9C%E7%B4%A2%E6%A1%86%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><span class="toc-text">2.4.6.实现旅游项目搜索框自动补全</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-mysql%E4%B8%8Ees%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-text">3.mysql与es数据同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-text">3.1.思路分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9A-%E5%90%8C%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-text">3.1.1. 方案一： 同步调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9A%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5"><span class="toc-text">3.1.2.方案二：异步通知</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-3-%E6%96%B9%E6%A1%88%E4%B8%89%EF%BC%9Acanal%E7%9B%91%E5%90%ACmysql%E7%9A%84binlog"><span class="toc-text">3.1.3.方案三：canal监听mysql的binlog</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-4-%E4%B8%89%E7%A7%8D%E6%96%B9%E6%A1%88%E4%BC%98%E7%BC%BA%E7%82%B9%E6%80%BB%E7%BB%93"><span class="toc-text">3.1.4.三种方案优缺点总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-MQ%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-text">3.2.MQ实现数据同步</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-%E6%80%9D%E8%B7%AF"><span class="toc-text">3.2.1.思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-%E5%AF%BC%E5%85%A5hotel-admin%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E7%AB%AF%E3%80%81%E4%BF%AE%E6%94%B9pom%E5%92%8Cyml"><span class="toc-text">3.2.2.导入hotel-admin后台管理端、修改pom和yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3-%E5%A3%B0%E6%98%8E%E4%BA%A4%E6%8D%A2%E6%9C%BA%E3%80%81%E9%98%9F%E5%88%97"><span class="toc-text">3.2.3.声明交换机、队列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-4-%E5%90%8E%E5%8F%B0%E7%AB%AF%E5%8F%91%E9%80%81MQ%E6%B6%88%E6%81%AF"><span class="toc-text">3.2.4.后台端发送MQ消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-5-%E7%94%A8%E6%88%B7%E7%AB%AF-%E6%8E%A5%E6%94%B6MQ%E6%B6%88%E6%81%AF"><span class="toc-text">3.2.5. 用户端 接收MQ消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-6-%E6%B5%8B%E8%AF%95"><span class="toc-text">3.2.6 测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-7-vue%E6%8F%92%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%BF%AB%E9%80%9F%E6%8B%B7%E8%B4%9D%E6%95%B0%E6%8D%AE%E5%88%B0%E8%A1%A8%E5%8D%95"><span class="toc-text">3.2.7.vue插件实现快速拷贝数据到表单</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E9%9B%86%E7%BE%A4"><span class="toc-text">4.集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-0-%E6%A6%82%E8%BF%B0"><span class="toc-text">4.0.概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E6%90%AD%E5%BB%BAES%E9%9B%86%E7%BE%A4"><span class="toc-text">4.1.搭建ES集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-0-Docker-Compose%E4%BB%8B%E7%BB%8D"><span class="toc-text">4.1.0.Docker Compose介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-%E5%88%9B%E5%BB%BAes%E9%9B%86%E7%BE%A4"><span class="toc-text">4.1.1.创建es集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7%EF%BC%8C%E5%AE%89%E8%A3%85cerebro"><span class="toc-text">4.1.2.集群状态监控，安装cerebro</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-3-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-text">4.1.3.创建索引库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-4-%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87%E6%95%88%E6%9E%9C"><span class="toc-text">4.1.4.查看分片效果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E9%9B%86%E7%BE%A4%E8%84%91%E8%A3%82%E9%97%AE%E9%A2%98"><span class="toc-text">4.2.集群脑裂问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-%E9%9B%86%E7%BE%A4%E8%81%8C%E8%B4%A3%E5%88%92%E5%88%86%EF%BC%8C%E5%9B%9B%E7%A7%8D%E8%8A%82%E7%82%B9%E7%B1%BB%E5%9E%8B"><span class="toc-text">4.2.1.集群职责划分，四种节点类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-%E8%84%91%E8%A3%82%E9%97%AE%E9%A2%98"><span class="toc-text">4.2.2.脑裂问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-3-%E5%B0%8F%E7%BB%93%EF%BC%8C%E5%9B%9B%E7%A7%8D%E8%8A%82%E7%82%B9%E7%B1%BB%E5%9E%8B"><span class="toc-text">4.2.3.小结，四种节点类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E9%9B%86%E7%BE%A4%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8"><span class="toc-text">4.3.集群分布式存储</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-1-%E6%96%87%E6%A1%A3%E5%AD%98%E5%82%A8%E5%88%B0%E5%88%86%E7%89%87%E6%B5%8B%E8%AF%95"><span class="toc-text">4.3.1.文档存储到分片测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-%E5%88%86%E7%89%87%E5%AD%98%E5%82%A8%E5%8E%9F%E7%90%86"><span class="toc-text">4.3.2.分片存储原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E9%9B%86%E7%BE%A4%E5%88%86%E5%B8%83%E5%BC%8F%E6%9F%A5%E8%AF%A2%EF%BC%8C%E5%8D%8F%E8%B0%83%E8%8A%82%E7%82%B9%E7%9A%84%E5%88%86%E6%95%A3%E5%92%8C%E8%81%9A%E9%9B%86"><span class="toc-text">4.4.集群分布式查询，协调节点的分散和聚集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E9%9B%86%E7%BE%A4%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-text">4.5.集群故障转移</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">格言🧬</p><div class="bg-ad"><div>再看看那个光点，它就在这里，这是家园，这是我们 —— 你所爱的每一个人，你认识的一个人，你听说过的每一个人，曾经有过的每一个人，都在它上面度过他们的一生✨</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://stellarium.org/">点击开启星辰之旅</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">猜你想看💡</p><ul class="ft-links"><li><a href="/posts/eec9786.html">魔改指南</a><a href="/box/nav/">网址导航</a></li><li><a href="/social/link/">我的朋友</a><a href="/comments/">留点什么</a></li><li><a href="/personal/about/">关于作者</a><a href="/archives/">文章归档</a></li><li><a href="/categories/">文章分类</a><a href="/tags/">文章标签</a></li><li><a href="/box/Gallery/">我的画廊</a><a href="/personal/bb/">我的唠叨</a></li><li><a href="/site/time/">建设进程</a><a href="/site/census/">网站统计</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">推荐友链⌛</p><div class="ft-img-group"><div class="img-group-item"><a href="https://www.fomal.cc/" title="Fomalhaut🥝"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/60e5d4e39da7c077.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div></div></div></div><div class="copyright"><span><b>&copy;2022-2025</b></span><span><b>&nbsp;&nbsp;By Wang Tong🥝</b></span></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="博客框架为Hexo_v6.3.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Frame-Hexo-blue.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="主题版本Butterfly_v4.3.1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Theme-Butterfly-6513df.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" title="本站采用多线部署，主线路托管于Vercel"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Hosted-Vercel-brightgreen.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://user.51.la/" style="margin-inline:5px" title="本站数据分析得益于51la技术支持"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Analytics-51la-3db1eb.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20226665" style="margin-inline:5px" title="本站已加入萌ICP豪华套餐，萌ICP备20226665号"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/萌ICP备-20226665-fe1384.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://bitiful.dogecast.com/buckets" style="margin-inline:5px" title="本网站经Service Worker分流至缤纷云对象存储"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Bucket-缤纷云-9c62da.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://www.netdun.net/" style="margin-inline:5px" title="本站使用网盾星球提供CDN加速与防护"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/CDN-网盾星球-fff2cc.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="本网站源码由Github提供存储仓库"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Source-Github-d021d6.svg" alt=""/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="浅色和深色模式转换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="右键模式" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="分享链接" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>百度搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>空降评论</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>复制本文地址</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>转到链接</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>随便逛逛</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>关于博客</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>美化设置</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>切换全屏</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>打印页面</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: '',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: '',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://www.fomal.cc/categories/演示/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍥 小Fの案例演示笔记 (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="https://www.fomal.cc/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_14.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-08-09</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">Markdown语法与外挂标签写法汇总</a><div class="blog-slider__text">🥧本文汇总Markdown格式以及外挂标签在网页端的渲染效果，可作为文档进行查询</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('已挂载gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/site/census/'|| '/site/census/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("/api?null",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'null')
    }
  </script><!-- hexo injector body_end end --></body></html>